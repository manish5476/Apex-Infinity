<p-toast></p-toast>

<div class="page-container animate-fadeIn">

  <div class="form-wrapper">
    <div class="form-header">
      <div class="header-content">
        <h1>{{ editMode() ? 'Edit User' : 'Create New User' }}</h1>
        <p>{{ editMode() ? 'Update existing user details and access.' : 'Onboard a new employee by assigning roles and credentials.' }}</p>
      </div>
      <p-button label="Back" icon="pi pi-times" styleClass="p-button-text p-button-secondary"
        (onClick)="onCancel()"></p-button>
    </div>

    <div class="form-card">
      <form [formGroup]="userForm" (ngSubmit)="onSubmit()">

        <div class="form-section">
          <div class="section-info">
            <h3>Identity</h3>
            <p>Basic personal information for the employee profile.</p>
          </div>

          <div class="section-fields glass-card">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-5">

              <div class="form-group">
                <label for="name">Full Name <span class="req">*</span></label>
                <div class="input-icon-wrapper">
                  <i class="pi pi-user"></i>
                  <input pInputText id="name" formControlName="name" placeholder="e.g. John Doe" class="w-full" />
                </div>
                @if (userForm.get('name')?.touched && userForm.get('name')?.invalid) {
                <small class="error-msg">Name is required (min 3 chars).</small>
                }
              </div>

              <div class="form-group">
                <label for="email">Email Address <span class="req">*</span></label>
                <div class="input-icon-wrapper">
                  <i class="pi pi-envelope"></i>
                  <input pInputText id="email" formControlName="email" placeholder="john@company.com" class="w-full" />
                </div>
                @if (userForm.get('email')?.touched && userForm.get('email')?.invalid) {
                <small class="error-msg">Valid email is required.</small>
                }
              </div>

              <div class="form-group">
                <label for="phone">Phone Number</label>
                <div class="input-icon-wrapper">
                  <i class="pi pi-phone"></i>
                  <input pInputText id="phone" formControlName="phone" placeholder="+91 98765 43210" class="w-full" />
                </div>
              </div>

              <div class="form-group">
                <label>Account Status</label>
                <div class="flex align-items-center gap-2 mt-2">
                  <p-toggleswitch formControlName="isActive"></p-toggleswitch>
                  <span class="text-sm font-medium">{{ userForm.get('isActive')?.value ? 'Active' : 'Inactive' }}</span>
                </div>
              </div>

            </div>
          </div>
        </div>

        <p-divider styleClass="my-6"></p-divider>

        <div class="form-section">
          <div class="section-info">
            <h3>Access Control</h3>
            <p>Define what this user can see and do within the system.</p>
          </div>

          <div class="section-fields glass-card">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-5">

              <div class="form-group">
                <label for="role">Assign Role <span class="req">*</span></label>
                <p-select id="role" formControlName="role" [options]="roles()" optionLabel="name" optionValue="_id"
                  placeholder="Select Role" [showClear]="true" styleClass="w-full" appendTo="body">
                </p-select>
                @if (userForm.get('role')?.touched && userForm.get('role')?.invalid) {
                <small class="error-msg">Role is required.</small>
                }
              </div>

              <div class="form-group">
                <label for="branch">Assign Branch</label>
                <p-select id="branch" formControlName="branchId" [options]="branches()" optionLabel="name"
                  optionValue="_id" placeholder="Select Branch (Optional)" [showClear]="true" styleClass="w-full"
                  appendTo="body">
                </p-select>
                <small class="hint-text">Leave empty for organization-wide access.</small>
              </div>

            </div>
          </div>
        </div>

        @if (!editMode() || userForm.get('password')?.value) {
        <p-divider styleClass="my-6"></p-divider>

        <div class="form-section">
          <div class="section-info">
            <h3>Credentials</h3>
            <p>Set a password for the user login.</p>
          </div>

          <div class="section-fields glass-card bg-blue-50 border-blue-100">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-5">

              <div class="form-group">
                <label for="password">Password <span *ngIf="!editMode()" class="req">*</span></label>
                <p-password id="password" formControlName="password" [toggleMask]="true" [feedback]="true"
                  placeholder="Min 8 characters" styleClass="w-full" inputStyleClass="w-full">
                </p-password>
                @if (userForm.get('password')?.touched && userForm.get('password')?.invalid) {
                <small class="error-msg">Password must be at least 8 characters.</small>
                }
              </div>

              <div class="form-group">
                <label for="confirm">Confirm Password <span *ngIf="!editMode()" class="req">*</span></label>
                <p-password id="confirm" formControlName="passwordConfirm" [toggleMask]="true" [feedback]="false"
                  placeholder="Re-enter password" styleClass="w-full" inputStyleClass="w-full">
                </p-password>
                @if (userForm.errors?.['mismatch'] && userForm.get('passwordConfirm')?.touched) {
                <small class="error-msg">Passwords do not match.</small>
                }
              </div>

            </div>
          </div>
        </div>
        }

        <div class="form-actions">
          <p-button label="Cancel" severity="secondary" [outlined]="true" (onClick)="onCancel()"></p-button>
          <p-button [label]="editMode() ? 'Update User' : 'Create User'" icon="pi pi-check" type="submit"
            [loading]="isSubmitting()"></p-button>
        </div>

      </form>
    </div>
  </div>
</div>