<div class="page-container animate-fadeIn">

  @if (!currentUser()) {
    <div class="loading-state">
      <div class="skeleton-header">
        <div class="left-group">
          <p-skeleton shape="circle" size="4rem"></p-skeleton>
          <div class="text-group">
            <p-skeleton width="12rem" height="1.5rem"></p-skeleton>
            <p-skeleton width="8rem" height="1rem"></p-skeleton>
          </div>
        </div>
      </div>
      <div class="layout-grid">
        <aside class="skeleton-sidebar">
          <p-skeleton height="400px" styleClass="w-full"></p-skeleton>
        </aside>
        <main class="skeleton-main">
          <p-skeleton height="200px" styleClass="w-full"></p-skeleton>
          <p-skeleton height="300px" styleClass="w-full"></p-skeleton>
        </main>
      </div>
    </div>
  }

  @else if (currentUser(); as user) {

    <header class="dashboard-header">
      <div class="header-left">
        <div class="identity-group">
          <div class="name-row">
            <h1>{{ user.name }}</h1>
            <p-tag [value]="user.isActive ? 'Active' : 'Inactive'" [severity]="user.isActive ? 'success' : 'danger'" styleClass="status-tag"></p-tag>
          </div>
          <div class="meta-row">
            <span class="role-badge">
              <i class="pi" [ngClass]="user.role.name === 'all access' ? 'pi-shield' : 'pi-user'"></i>
              {{ user.role.name | uppercase }}
            </span>
            <span class="org-badge">{{ user.organizationId }}</span>
          </div>
        </div>
      </div>

      <div class="header-actions">
        <button pButton label="Edit Profile" icon="pi pi-user-edit" class="p-button-outlined p-button-secondary btn-sm"></button>
      </div>
    </header>

    <div class="layout-grid">

      <aside class="sidebar-column">
        
        <div class="profile-card">
          <div class="card-banner"></div>
          
          <div class="profile-content">
            
            <div class="avatar-wrapper" (click)="!uploading() && triggerFileInput()">
              <div class="avatar-circle">
                @if (user.avatar) {
                  <img [src]="user.avatar" [alt]="user.name" class="profile-image">
                } @else {
                  <span class="initials">{{ getInitials(user.name) }}</span>
                }
                
                <div class="avatar-overlay">
                  <i class="pi pi-camera"></i>
                </div>

                @if (uploading()) {
                  <div class="avatar-loader"><i class="pi pi-spin pi-spinner"></i></div>
                }
              </div>
              <div class="status-dot" [class.active]="user.isActive"></div>
            </div>
            
            <input type="file" #fileInput (change)="onFileSelected($event)" accept="image/*" style="display: none;">

            <h3 class="contact-name">{{ user.name }}</h3>
            <span class="contact-email">{{ user.email }}</span>

            <div class="info-list">
              <div class="info-item">
                <div class="icon-box"><i class="pi pi-calendar"></i></div>
                <div class="info-text">
                  <label>Joined</label>
                  <span>{{ user.createdAt | date:'mediumDate' }}</span>
                </div>
              </div>
              
              <div class="info-item">
                <div class="icon-box"><i class="pi pi-id-card"></i></div>
                <div class="info-text">
                  <label>User ID</label>
                  <span class="font-mono text-xs">{{ user._id | slice:0:8 }}...</span>
                </div>
              </div>
            </div>

            @if (uploadError()) {
              <div class="error-alert">
                <i class="pi pi-exclamation-circle"></i> {{ uploadError() }}
              </div>
            }
          </div>
        </div>

        @if (user.branchId; as branch) {
          <div class="glass-card branch-card">
            <div class="card-header">
              <i class="pi pi-building"></i> <span>Assigned Branch</span>
            </div>
            <div class="card-body">
              <h4 class="branch-name">{{ branch.name }}</h4>
              <p class="branch-address">
                {{ branch.address.city }}, {{ branch.address.state }}<br>
                <span class="text-xs text-muted">{{ branch.address.country }} - {{ branch.address.zipCode }}</span>
              </p>
            </div>
          </div>
        }

        <div class="glass-card pref-card">
          <div class="card-header">
            <i class="pi pi-cog"></i> <span>Preferences</span>
          </div>
          <div class="card-body">
            <div class="pref-row">
              <span>Dark Mode</span>
              <div class="status-indicator" [class.on]="user.preferences.theme === 'dark'"></div>
            </div>
            <div class="pref-row">
              <span>Dense Mode</span>
              <div class="status-indicator" [class.on]="user.preferences.denseMode"></div>
            </div>
            <div class="tags-row">
              <span class="pref-tag" [class.active]="user.preferences.notifications.email">Email</span>
              <span class="pref-tag" [class.active]="user.preferences.notifications.push">Push</span>
              <span class="pref-tag" [class.active]="user.preferences.notifications.sms">SMS</span>
            </div>
          </div>
        </div>

      </aside>

      <main class="main-column">
        
        <section class="glass-card permissions-panel">
          <div class="card-header">
            <div class="flex items-center gap-2">
              <i class="pi pi-lock"></i> 
              <span>Access & Permissions</span>
            </div>
            <span class="count-badge">{{ user.role.permissions?user.role.permissions.length:0 }} Perms</span>
          </div>

          <div class="card-body">
            <div class="permissions-grid">
              @for (perm of user.role.permissions; track perm) {
                <div class="perm-chip">
                  <i class="pi pi-check-circle"></i>
                  <span>{{ formatPermission(perm) }}</span>
                </div>
              }
            </div>
          </div>
        </section>

        <section class="glass-card meta-panel">
          <div class="card-header">
            <i class="pi pi-server"></i> <span>System Metadata</span>
          </div>
          <div class="card-body grid-2">
            <div class="meta-box">
              <label>Last Updated</label>
              <span class="val">{{ user.updatedAt | date:'medium' }}</span>
            </div>
            <div class="meta-box">
              <label>Account Status</label>
              <span class="val status-text" [class.active]="user.isActive">
                {{ user.isActive ? 'Operational' : 'Suspended' }}
              </span>
            </div>
          </div>
        </section>

      </main>

    </div>
  }
</div>