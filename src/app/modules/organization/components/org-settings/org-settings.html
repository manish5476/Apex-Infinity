<p-toast position="top-right"></p-toast>
<p-confirmDialog></p-confirmDialog>

<div class="page-container animate-fadeIn">
  
  @if (!isLoading() && organization()) {
  <div class="org-layout">

    <header class="org-header">
      <div class="header-content">
        <div class="header-left">
          <button class="back-button" routerLink="/admin/dashboard" pTooltip="Back">
            <i class="pi pi-arrow-left"></i>
          </button>
          <div class="org-identity">
            <h1>{{ organization().name }}</h1>
            <div class="org-meta">
              <p-tag [value]="organization().isActive ? 'Active' : 'Inactive'" 
                     [severity]="organization().isActive ? 'success' : 'danger'" [rounded]="true"></p-tag>
              <span class="meta-item hide-mobile">|</span>
              <span class="meta-item hide-mobile">#{{ organization().uniqueShopId }}</span>
            </div>
          </div>
        </div>
      </div>
    </header>

    <main class="org-body">

      <aside class="org-sidebar">
        <div class="logo-section">
          <div class="logo-placeholder"><span>{{ getInitials(organization().name) }}</span></div>
          <h4>{{ organization().name }}</h4>
          <p>#{{ organization().uniqueShopId }}</p>
        </div>

        <div class="sidebar-details">
          <div class="detail-item">
            <label><i class="pi pi-envelope"></i> Email</label>
            <span class="value">{{ organization().primaryEmail }}</span>
          </div>
          <div class="detail-item">
            <label><i class="pi pi-map-marker"></i> HQ</label>
            <span class="value">{{ organization().branches?.[0]?.name || 'Main' }}</span>
          </div>
        </div>

        <div class="sidebar-stats">
          <div class="stat-card">
            <div class="stat-value">{{ activeMembers().length }}</div>
            <div class="stat-label">Users</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">{{ organization().branches?.length || 1 }}</div>
            <div class="stat-label">Branches</div>
          </div>
        </div>
      </aside>

      <section class="org-content">
        <p-tabs [value]="activeTabValue()" (valueChange)="onTabChange($event)">
          <p-tablist>
            <p-tab value="0">General</p-tab>
            <p-tab value="1">Team @if(pendingMembers().length){<p-badge [value]="pendingMembers().length.toString()" severity="warn" styleClass="ml-2"></p-badge>}</p-tab>
            <!-- <p-tab value="2">Activity</p-tab> -->
            @if (isOwner()) { <p-tab value="3">Security</p-tab> }
          </p-tablist>

          <p-tabpanels>
            
            <p-tabpanel value="0">
              <div class="panel-content animate-fadeInUp">
                <div class="panel-header"><h3>Details</h3><p>Manage company profile.</p></div>
                <form [formGroup]="orgForm" (ngSubmit)="updateOrgDetails()" class="form-grid">
                  <div class="field"><label>Name <span class="req">*</span></label><input pInputText formControlName="name" /></div>
                  <div class="field"><label>GST</label><input pInputText formControlName="gstNumber" /></div>
                  <div class="field"><label>Email</label><input pInputText formControlName="primaryEmail" /></div>
                  <div class="field"><label>Phone</label><input pInputText formControlName="primaryPhone" /></div>
                  <div class="form-actions">
                    <button pButton label="Save Changes" icon="pi pi-check" type="submit" [loading]="isSaving()"></button>
                  </div>
                </form>
              </div>
            </p-tabpanel>

            <p-tabpanel value="1">
              <div class="panel-content animate-fadeInUp">
                <div class="flex justify-between items-center mb-4">
                  <h3>Active Members</h3>
                  <button pButton label="Invite" icon="pi pi-plus" class="p-button-sm" (click)="showInviteDialog = true"></button>
                </div>

                <div class="grid-wrapper">
                  <app-ag-share-grid [columns]="column" [data]="activeMembers()" [showActions]="true" (gridEvent)="eventFromGrid($event)"></app-ag-share-grid>
                </div>

                @if (pendingMembers().length > 0) {
                  <div class="mt-8">
                    <h4 class="mb-3 text-orange-600">Pending Requests</h4>
                    <div class="grid gap-3">
                      @for (pending of pendingMembers(); track pending._id) {
                        <div class="list-item">
                          <div>
                            <div class="font-bold">{{ pending.name }}</div>
                            <div class="text-sm text-gray-500">{{ pending.email }}</div>
                          </div>
                          <div class="actions flex gap-2">
                            <p-select appendTo="body" [options]="roles" [(ngModel)]="selectedRoles[pending._id]" optionLabel="name" optionValue="_id" placeholder="Role" styleClass="w-32" />
                            <p-select appendTo="body" [options]="branches" [(ngModel)]="selectedBranches[pending._id]" optionLabel="name" optionValue="_id" placeholder="Branch" styleClass="w-32" />
                            <button pButton icon="pi pi-check" class="p-button-success" (click)="approveMember(pending._id)"></button>
                          </div>
                        </div>
                      }
                    </div>
                  </div>
                }
              </div>
            </p-tabpanel>

            <p-tabpanel value="2">
              <div class="panel-content animate-fadeInUp">
                <div class="panel-header"><h3>Audit Log</h3></div>
                
                <div class="activity-scroll-container">
                  @if (activityLogs().length > 0) {
                    <p-timeline [value]="activityLogs()" align="left" styleClass="timeline-custom">
                      <ng-template pTemplate="marker" let-log>
                        <div class="custom-marker"><i class="pi pi-circle-fill"></i></div>
                      </ng-template>
                      <ng-template pTemplate="content" let-log>
                        <div class="log-item">
                          <div class="log-header">
                            <span class="log-desc">{{ log.description }}</span>
                          </div>
                          <div class="log-meta">
                            <span>{{ log.createdAt | date:'short' }}</span>
                            <span class="log-user">{{ log.userId?.name || 'System' }}</span>
                          </div>
                        </div>
                      </ng-template>
                    </p-timeline>
                  } @else {
                    <div class="text-center p-8 text-gray-400">No activity found.</div>
                  }
                </div>
              </div>
            </p-tabpanel>

            @if (isOwner()) {
              <p-tabpanel value="3">
                <div class="panel-content animate-fadeInUp">
                  <div class="panel-header"><h3 class="text-red-600">Danger Zone</h3></div>
                  <div class="list-item border-orange-200 bg-orange-50 mb-3">
                    <div><strong>Transfer Ownership</strong><p class="text-sm m-0">Give control to another admin.</p></div>
                    <button pButton label="Transfer" class="p-button-warning" (click)="showTransferDialog = true"></button>
                  </div>
                  <div class="list-item border-red-200 bg-red-50">
                    <div><strong>Delete Organization</strong><p class="text-sm m-0">Permanently delete data.</p></div>
                    <button pButton label="Delete" class="p-button-danger" (click)="deleteOrganization()"></button>
                  </div>
                </div>
              </p-tabpanel>
            }
          </p-tabpanels>
        </p-tabs>
      </section>
    </main>
  </div>
  } @else {
    <div style="height: 100vh; display: flex; align-items: center; justify-content: center;">
      <i class="pi pi-spin pi-spinner text-4xl text-blue-500"></i>
    </div>
  }
</div>

<p-dialog header="Invite Member" [(visible)]="showInviteDialog" [modal]="true" [style]="{width: '90vw', maxWidth: '450px'}">
  <form [formGroup]="inviteForm" class="flex flex-col gap-4 mt-3">
    <div class="field"><label>Name</label><input pInputText formControlName="name" class="w-full"/></div>
    <div class="field"><label>Email</label><input pInputText formControlName="email" class="w-full"/></div>
    <div class="field"><label>Role</label><select formControlName="role" class="w-full p-2 border rounded">@for(r of availableRoles; track r.value) { <option [value]="r.value">{{r.label}}</option> }</select></div>
  </form>
  <ng-template pTemplate="footer"><button pButton label="Send" (click)="inviteUser()" [loading]="isSaving()"></button></ng-template>
</p-dialog>

<p-dialog header="Transfer Ownership" [(visible)]="showTransferDialog" [modal]="true" [style]="{width: '90vw', maxWidth: '500px'}">
  <form [formGroup]="transferForm" class="flex flex-col gap-4 mt-3">
    <div class="field"><label>New Owner</label><select formControlName="newOwnerId" class="w-full p-2 border rounded">@for (m of activeMembers(); track m._id) { @if(m._id !== organization().owner._id) { <option [value]="m._id">{{m.name}}</option> } }</select></div>
    <div class="field"><label>Type <b>CONFIRM</b></label><input pInputText formControlName="confirmName" class="w-full"/></div>
  </form>
  <ng-template pTemplate="footer"><button pButton label="Transfer" class="p-button-danger" [disabled]="transferForm.invalid || transferForm.value.confirmName !== 'CONFIRM'" (click)="transferOwnership()"></button></ng-template>
</p-dialog>