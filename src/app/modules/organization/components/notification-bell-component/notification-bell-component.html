<div class="bell-trigger relative cursor-pointer" (click)="toggleDropdown()">
  <i class="pi pi-bell text-xl text-[var(--text-secondary)] hover:text-[var(--text-primary)] transition-colors"></i>
  @if (unreadCount > 0) {
    <p-badge [value]="unreadCount" severity="danger" styleClass="absolute -top-2 -right-2 text-xs"></p-badge>
  }
</div>

@if (showDropdown) {
  <div class="notification-dropdown-overlay">
    
    <div class="dropdown-header">
      <div class="tab-segment">
        
        <button class="tab-btn" [class.active]="activeTab === 0" (click)="switchTab(0)">
          <span>New</span>
          @if (unreadCount > 0) {
            <span class="count-badge red">{{ unreadCount }}</span>
          }
        </button>

        <button class="tab-btn" [class.active]="activeTab === 1" (click)="switchTab(1)">
          <span>Approvals</span>
          @if (pendingMembers.length > 0) {
            <span class="count-badge orange">{{ pendingMembers.length }}</span>
          }
        </button>

        <button class="tab-btn" [class.active]="activeTab === 2" (click)="switchTab(2)">
          <span>History</span>
        </button>
      </div>
    </div>

    <div class="dropdown-body">
      
      @if (activeTab === 0) {
        <ul class="notif-list">
          @for (n of realtimeNotifications; track n._id) {
            <li class="notif-item unread" (click)="markAsRead(n)">
              <div class="icon-box blue"><i class="pi pi-bolt"></i></div>
              <div class="content">
                <div class="row-top">
                  <span class="title">{{ n.title }}</span>
                  <span class="time">{{ n.createdAt | date:'shortTime' }}</span>
                </div>
                <p class="msg">{{ n.message }}</p>
              </div>
              <div class="status-dot"></div>
            </li>
          }
          @if (!isLoading && realtimeNotifications.length === 0) {
            <div class="empty-state">
              <i class="pi pi-check-circle"></i>
              <p>You're all caught up!</p>
            </div>
          }
        </ul>
      }

      @if (activeTab === 1) {
        <div class="approval-list">
          @if (isLoading) {
             <div class="p-3"><p-skeleton height="4rem"></p-skeleton></div>
          }

          @for (member of pendingMembers; track member._id) {
            <div class="approval-card">
              <div class="card-head">
                <div class="user-details">
                  <span class="name">{{ member.name }}</span>
                  <span class="email">{{ member.email }}</span>
                </div>
                <i class="pi pi-user-edit text-[var(--accent-primary)]"></i>
              </div>
              
              <div class="card-form">
                <p-select appendTo="body" 
                          [options]="roles" 
                          [(ngModel)]="selectedRoles[member._id]" 
                          optionLabel="name" 
                          optionValue="_id" 
                          placeholder="Select Role" 
                          styleClass="w-full text-sm mb-2">
                </p-select>

                <p-select appendTo="body" 
                          [options]="branches" 
                          [(ngModel)]="selectedBranches[member._id]" 
                          optionLabel="name" 
                          optionValue="_id" 
                          placeholder="Select Branch" 
                          styleClass="w-full text-sm mb-2">
                </p-select>

                <p-button label="Approve Request" 
                          icon="pi pi-check" 
                          styleClass="w-full p-button-sm" 
                          [disabled]="!selectedRoles[member._id] || !selectedBranches[member._id]"
                          (onClick)="approveMember(member)">
                </p-button>
              </div>
            </div>
          }
          
          @if (!isLoading && pendingMembers.length === 0) {
            <div class="empty-state">
              <i class="pi pi-users"></i>
              <p>No pending approvals.</p>
            </div>
          }
        </div>
      }

      @if (activeTab === 2) {
        <ul class="notif-list">
          @for (n of allNotifications; track n._id) {
            <li class="notif-item">
              <div class="content full">
                <div class="row-top">
                  <span class="title">{{ n.title }}</span>
                  <span class="time">{{ n.createdAt | date:'MMM d' }}</span>
                </div>
                <p class="msg">{{ n.message }}</p>
              </div>
            </li>
          }
          @if (!isLoading && allNotifications.length === 0) {
            <div class="empty-state">
              <i class="pi pi-history"></i>
              <p>No history found.</p>
            </div>
          }
        </ul>
      }

    </div>
  </div>
}
