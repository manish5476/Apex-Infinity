<div class="relative">
  <button class="relative p-2" (click)="toggleDropdown()" pTooltip="Notifications" tooltipPosition="bottom">
    <i class="pi pi-bell text-lg text-[var(--text-primary)]"></i>

    @if (unreadCount > 0) {
      <span class="absolute -top-1 -right-1 bg-red-500 text-white text-xs px-1.5 rounded-full animate-pulse">
        {{ unreadCount }}
      </span>
    }
  </button>

  @if (showDropdown) {
    <div class="absolute right-0 mt-2 w-80 sm:w-96 notif-box">

      <!-- Filter Buttons -->
      <div class="flex filter-container">
        <button class="filter-btn"
          [ngClass]="{ 'active': activeSection === 'new' }"
          (click)="activeSection = 'new'">
          New
        </button>

        <button class="filter-btn"
          [ngClass]="{ 'active': activeSection === 'approvals' }"
          (click)="activeSection = 'approvals'">
          Approvals
        </button>

        <button class="filter-btn"
          [ngClass]="{ 'active': activeSection === 'all' }"
          (click)="activeSection = 'all'">
          All
        </button>
      </div>

      <!-- Scrollable Content -->
      <div class="notif-content">

        @if (isLoading) {
          <div class="p-3">
            <p-skeleton height="2rem" styleClass="mb-2"></p-skeleton>
            <p-skeleton height="2rem" styleClass="mb-2"></p-skeleton>
            <p-skeleton height="2rem"></p-skeleton>
          </div>
        }

        <!-- New Notifications -->
        @if (!isLoading && activeSection === 'new') {
          @for (n of realtimeNotifications; track n._id) {
            <div class="notif-item unread" (click)="markAsRead(n)">
              <div class="notif-title">{{ n.title }}</div>
              <div class="notif-msg">{{ n.message }}</div>
              <div class="notif-time">{{ n.createdAt | date: 'short' }}</div>
            </div>
          }

          @if (realtimeNotifications.length === 0) {
            <div class="empty">No new notifications.</div>
          }
        }

        <!-- Approvals -->
        @if (!isLoading && activeSection === 'approvals') {
          @for (member of pendingMembers; track member._id) {
            <div class="notif-item">
              <div class="notif-title">{{ member.name }}</div>
              <div class="notif-time">{{ member.email }}</div>

              <div class="mt-3 flex flex-col gap-2">
                <p-select appendTo="body"
                  [options]="roles"
                  optionLabel="name"
                  optionValue="_id"
                  [(ngModel)]="selectedRoles[member._id]"
                  placeholder="Select Role"></p-select>

                <p-select appendTo="body"
                  [options]="branches"
                  optionLabel="name"
                  optionValue="_id"
                  [(ngModel)]="selectedBranches[member._id]"
                  placeholder="Select Branch"></p-select>

                <p-button label="Approve" icon="pi pi-check"
                  styleClass="p-button-sm w-full"
                  [disabled]="!selectedRoles[member._id] || !selectedBranches[member._id]"
                  (click)="approveMember(member)">
                </p-button>

              </div>
            </div>
          }

          @if (pendingMembers.length === 0) {
            <div class="empty">No pending requests.</div>
          }
        }

        <!-- All Notifications -->
        @if (!isLoading && activeSection === 'all') {
          @for (n of allNotifications; track n._id) {
            <div class="notif-item">
              <div class="notif-title">{{ n.title }}</div>
              <div class="notif-msg">{{ n.message }}</div>
              <div class="notif-time">{{ n.createdAt | date: 'short' }}</div>
            </div>
          }

          @if (allNotifications.length === 0) {
            <div class="empty">No history.</div>
          }
        }
      </div>
    </div>
  }
</div>