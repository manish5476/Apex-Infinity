<div class="customer-page-container animate-fadeIn">
  
  @if (payment(); as p) {
    <div class="themed-card payment-details-card">
      
      <div class="details-header">
        <div class="header-left">
          <p-button 
            icon="pi pi-arrow-left" 
            styleClass="p-button-text p-button-rounded p-button-secondary"
            routerLink="/payments">
          </p-button>
          
          <div class="header-identity">
             <div class="title-row">
               <h2 class="form-title">Payment #{{ p.referenceNumber || (p._id | slice:-6) | uppercase }}</h2>
               <p-tag 
                 [value]="p.status | uppercase" 
                 [severity]="getStatusSeverity(p.status)"
                 styleClass="status-tag">
               </p-tag>
             </div>
             <div class="subtitle-row">
               <span class="date-text"><i class="pi pi-calendar"></i> {{ formatDate(p.paymentDate) }}</span>
               <span class="separator">•</span>
               <span class="method-text"><i class="pi pi-wallet"></i> {{ p.paymentMethod | titlecase }}</span>
             </div>
          </div>
        </div>
        
        <div class="header-actions">
          <p-button label="Print Receipt" icon="pi pi-print" styleClass="p-button-outlined p-button-sm"></p-button>
          <p-button label="Edit" icon="pi pi-pencil" styleClass="p-button-primary p-button-sm" [routerLink]="['/payments', p._id, 'edit']"></p-button>
          <p-button icon="pi pi-ellipsis-v" styleClass="p-button-text p-button-rounded p-button-secondary"></p-button>
        </div>
      </div>

      <div class="details-body">

        <aside class="profile-sidebar animate-slideInUp">
          
          <div class="flow-indicator" [class.inflow]="p.type === 'inflow'" [class.outflow]="p.type === 'outflow'">
             <i class="pi" [class.pi-arrow-down-left]="p.type === 'inflow'" [class.pi-arrow-up-right]="p.type === 'outflow'"></i>
             <span>{{ p.type === 'inflow' ? 'Payment Received' : 'Payment Made' }}</span>
          </div>

          <p-divider styleClass="w-full"></p-divider>

          <div class="party-card">
             <label class="text-xs uppercase text-[var(--text-secondary)] font-bold mb-2 block">
                {{ p.type === 'inflow' ? 'Received From' : 'Paid To' }}
             </label>
             
             @if (p.type === 'inflow' && p.customer) {
                <div class="party-info">
                   <div class="avatar-placeholder customer"><i class="pi pi-user"></i></div>
                   <div class="party-text">
                      <h4>{{ p.customer.name }}</h4>
                      <a [routerLink]="['/customer', p.customer._id]" class="link">View Profile</a>
                   </div>
                </div>
             }
             @if (p.type === 'outflow' && p.supplier) {
                <div class="party-info">
                   <div class="avatar-placeholder supplier"><i class="pi pi-box"></i></div>
                   <div class="party-text">
                      <h4>{{ p.supplier.name }}</h4>
                      <span>Supplier</span>
                   </div>
                </div>
             }
          </div>

          <div class="attributes-list mt-4">
             <div class="attribute-item">
                <div class="attr-icon"><i class="pi pi-building"></i></div>
                <div class="attr-data">
                   <label>Bank / Gateway</label>
                   <span>{{ p.bankName || 'N/A' }}</span>
                </div>
             </div>
             <div class="attribute-item">
                <div class="attr-icon"><i class="pi pi-receipt"></i></div>
                <div class="attr-data">
                   <label>Transaction ID</label>
                   <span class="font-mono text-xs">{{ p.transactionId || 'N/A' }}</span>
                </div>
             </div>
             <div class="attribute-item">
                <div class="attr-icon"><i class="pi pi-map-marker"></i></div>
                <div class="attr-data">
                   <label>Branch</label>
                   <span>{{ p.branch?.name || 'Main Branch' }}</span>
                </div>
             </div>
          </div>

        </aside>

        <section class="main-details">

           <div class="amount-hero-card animate-slideInUp" [class.inflow]="p.type === 'inflow'" [class.outflow]="p.type === 'outflow'">
              <div class="amount-content">
                 <label>Total Amount</label>
                 <div class="amount-value">
                    <span class="currency">₹</span>
                    <span class="val">{{ p.amount | number:'1.2-2' }}</span>
                 </div>
              </div>
              <div class="status-pill">
                 <i class="pi pi-check-circle"></i> {{ p.status | titlecase }}
              </div>
           </div>

           @if (p.invoice || p.purchase) {
             <div class="content-section animate-slideInUp" style="animation-delay: 0.1s;">
                <h4 class="section-heading"><i class="pi pi-link"></i> Linked Documents</h4>
                
                <div class="linked-docs-grid">
                   @if (p.invoice) {
                      <div class="doc-card invoice">
                         <div class="doc-icon"><i class="pi pi-file"></i></div>
                         <div class="doc-info">
                            <label>Sales Invoice</label>
                            <span class="doc-number">{{ p.invoice.invoiceNumber }}</span>
                         </div>
                         <p-button icon="pi pi-arrow-right" styleClass="p-button-rounded p-button-text"></p-button>
                      </div>
                   }
                   @if (p.purchase) {
                      <div class="doc-card purchase">
                         <div class="doc-icon"><i class="pi pi-shopping-bag"></i></div>
                         <div class="doc-info">
                            <label>Purchase Order</label>
                            <span class="doc-number">{{ p.purchase.purchaseNumber }}</span>
                         </div>
                         <p-button icon="pi pi-arrow-right" styleClass="p-button-rounded p-button-text"></p-button>
                      </div>
                   }
                </div>
             </div>
           }

           <div class="content-section animate-slideInUp" style="animation-delay: 0.2s;">
              <h4 class="section-heading"><i class="pi pi-align-left"></i> Remarks</h4>
              <div class="remarks-box">
                 <p>{{ p.remarks || 'No additional remarks provided for this transaction.' }}</p>
              </div>
           </div>

        </section>

      </div>
    </div>
  } @else {
    <div class="loading-state">
       <i class="pi pi-spin pi-spinner text-4xl text-[var(--text-secondary)]"></i>
       <p class="mt-2 text-[var(--text-secondary)]">Loading Payment...</p>
    </div>
  }
</div>