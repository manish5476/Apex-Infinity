<p-toast></p-toast>
<p-confirmDialog></p-confirmDialog>

<div class="master-page-container">
  
  <div class="themed-card master-card">

    <p-toolbar styleClass="master-toolbar">
      <div class="p-toolbar-group-start gap-3">
        <h2 class="section-heading m-0">Master Data Management</h2>

        <p-iconfield iconPosition="left">
          <p-inputicon styleClass="pi pi-search"></p-inputicon>
          <input pInputText type="text" (input)="onQuickFilter($event)" placeholder="Search records..."
            class="p-inputtext-sm w-64" />
        </p-iconfield>
      </div>

      <div class="p-toolbar-group-end flex gap-2">
        <p-button label="Bulk Add" icon="pi pi-table" styleClass="p-button-outlined"
          (click)="openBulkCreate()"></p-button>
        <p-button label="Add New" icon="pi pi-plus" (click)="openCreate()"></p-button>
      </div>
    </p-toolbar>

    <div class="master-grid-wrapper">
      <app-ag-share-grid 
        [columns]="column" 
        [data]="data" 
        [showActions]="false" 
        selectionMode="multiple"
        (gridEvent)="eventFromGrid($event)" 
        style="height: 100%; width: 100%; display: block;">
      </app-ag-share-grid>
    </div>

  </div>
</div>

<p-dialog [(visible)]="singleDialogVisible" [modal]="true" [style]="{ width: '500px' }"
  header="{{ isEdit() ? 'Edit Master Entry' : 'Create New Master Entry' }}" styleClass="master-dialog"
  [draggable]="false" [resizable]="false">

  <form [formGroup]="singleForm" class="dialog-form">
    <div class="form-group">
      <label>Type <span class="req">*</span></label>
      <p-select [options]="masterTypes" formControlName="type" optionLabel="label" optionValue="value"
        placeholder="Select type" appendTo="body" styleClass="w-full">
      </p-select>
      @if (singleForm.get('type')?.invalid && singleForm.get('type')?.touched) {
      <small class="error-message">Type is required.</small>
      }
    </div>

    <div class="form-group">
      <label>Name <span class="req">*</span></label>
      <input pInputText formControlName="name" placeholder="Enter name (e.g., Electronics)" class="w-full" />
      @if (singleForm.get('name')?.invalid && singleForm.get('name')?.touched) {
      <small class="error-message">Name is required.</small>
      }
    </div>

    <div class="form-group">
      <label>Code</label>
      <input pInputText formControlName="code" placeholder="Optional short code (e.g., ELE)"
        class="w-full style-uppercase" />
    </div>

    <div class="form-group">
      <label>Description</label>
      <textarea pInputTextarea formControlName="description" rows="3" placeholder="Optional details..."
        class="w-full"></textarea>
    </div>
  </form>

  <ng-template pTemplate="footer">
    <div class="flex justify-end gap-2">
      <p-button label="Cancel" styleClass="p-button-text p-button-secondary"
        (click)="singleDialogVisible.set(false)"></p-button>
      <p-button label="Save" (click)="saveSingle()" [disabled]="singleForm.invalid || loading()"></p-button>
    </div>
  </ng-template>

</p-dialog>

<p-dialog [(visible)]="bulkDialogVisible" [modal]="true" [style]="{ width: '900px' }" header="Bulk Add Master Data"
  styleClass="bulk-dialog" [draggable]="false" [resizable]="false">

  <div class="bulk-scroll-wrapper" style="max-height: 60vh; overflow-y: auto; padding: 0.5rem;">

    <form [formGroup]="bulkForm" class="dialog-form bulk-form-layout">

      <div class="bulk-control-panel flex justify-between items-end border-b pb-4 mb-4">
        <div class="form-group w-1/3">
          <label class="font-semibold block mb-2">Master Type <span class="req text-red-500">*</span></label>
          <p-select [options]="masterTypes" formControlName="type" optionLabel="label" optionValue="value"
            placeholder="Select ONE type for all entries" appendTo="body" styleClass="w-full">
          </p-select>
          @if (bulkForm.get('type')?.invalid && bulkForm.get('type')?.touched) {
          <small class="error-message text-red-500">Master Type is required.</small>
          }
        </div>
        <p-button label="Add Row" icon="pi pi-plus" (click)="addBulkDataItem()"
          styleClass="p-button-outlined p-button-sm" [disabled]="bulkForm.get('type')?.invalid"></p-button>
      </div>

      <div class="bulk-data-table border rounded">
        <div class="bulk-header-row flex bg-gray-100 p-2 font-semibold border-b">
          <span style="width: 35%;">Name <span class="text-red-500">*</span></span>
          <span style="width: 25%;">Code (Uppercase)</span>
          <span style="width: 30%;">Description</span>
          <span style="width: 10%;"></span>
        </div>

        <div formArrayName="bulkData" class="bulk-data-rows bg-white">
          @for (item of bulkData.controls; track $index; let i = $index) {
          <div [formGroupName]="i" class="bulk-item-row flex items-center p-2 gap-2 border-b last:border-b-0">
            <div class="form-group-inline" style="width: 35%;">
              <input pInputText formControlName="name" placeholder="Enter name" class="w-full p-inputtext-sm" />
              @if (item.get('name')?.invalid && item.get('name')?.touched) {
              <small class="error-message text-red-500 text-xs">Required</small>
              }
            </div>
            <div class="form-group-inline" style="width: 25%;">
              <input pInputText formControlName="code" placeholder="Code"
                class="w-full p-inputtext-sm uppercase-input" />
            </div>

            <div class="form-group-inline" style="width: 30%;">
              <input pInputText formControlName="description" placeholder="Description" class="w-full p-inputtext-sm" />
            </div>

            <div style="width: 10%;" class="text-center">
              <p-button icon="pi pi-trash" [text]="true" severity="danger" (click)="removeBulkDataItem(i)"
                [disabled]="bulkData.length === 1">
              </p-button>
            </div>
          </div>
          }
        </div>
      </div>
    </form>

  </div>
  <ng-template pTemplate="footer">
    <div class="flex justify-end gap-2 pt-2">
      <p-button label="Cancel" styleClass="p-button-text p-button-secondary" (click)="bulkDialogVisible.set(false)">
      </p-button>

      <p-button label="Save All" (click)="saveBulk()" [loading]="loading()" [disabled]="bulkData.length === 0">
      </p-button>
    </div>
  </ng-template>
</p-dialog>