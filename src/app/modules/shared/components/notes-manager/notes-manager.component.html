<p-toast position="bottom-right" zIndex="2000"></p-toast>

<div class="erp-glass-widget" 
     [style.transform]="'perspective(1000px) rotateX(' + rotateX() + 'deg) rotateY(' + rotateY() + 'deg)'">
  
  <div class="noise-overlay"></div>

  <header class="widget-header">
    <div class="header-left">
      <div class="icon-box">
        <i class="pi pi-book"></i>
      </div>
      <div>
        <h2>My Journal</h2>
        <span class="subtitle">Daily Overview</span>
      </div>
    </div>

    <div class="nav-pills">
      <button class="nav-item" [class.active]="activeView() === 'calendar'" (click)="switchView('calendar')">
        <i class="pi pi-calendar"></i> Calendar
      </button>
      <button class="nav-item" [class.active]="activeView() === 'archive'" (click)="switchView('archive')">
        <i class="pi pi-database"></i> Archive
      </button>
    </div>

    <button class="btn-add-mini" (click)="openNewNote()" pTooltip="Create New Entry">
      <i class="pi pi-plus"></i>
    </button>
  </header>

  <div class="widget-body custom-scrollbar">

    @if (activeView() === 'calendar') {
      <div class="split-layout animate-fade-up">
        
        <div class="calendar-section">
            <div class="cal-controls">
                <button class="btn-text" (click)="changeMonth(-1)"><i class="pi pi-chevron-left"></i></button>
                <span class="current-month">{{ currentMonthName() }}</span>
                <button class="btn-text" (click)="changeMonth(1)"><i class="pi pi-chevron-right"></i></button>
                <button class="btn-today" (click)="jumpToToday()">Today</button>
            </div>

            <div class="cal-grid-header">
                @for (day of ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat']; track day) {
                    <span>{{ day }}</span>
                }
            </div>

            <div class="cal-grid">
                @for (day of calendarDays(); track $index) {
                    <div class="cal-day" 
                         [class.faded]="!day.isCurrentMonth"
                         [class.today]="day.isToday"
                         [class.selected]="day.isSelected"
                         (click)="selectDay(day)">
                        
                        <span>{{ day.dayNum }}</span>
                        
                        @if(day.noteCount > 0) {
                            <div class="dot-container">
                                @for (item of getIndicators(day.noteCount); track $index) {
                                    <span class="dot-indicator"></span>
                                }
                            </div>
                        }
                    </div>
                }
            </div>

            <div class="stats-mini">
                <div class="stats-icon"><i class="pi pi-bolt"></i></div>
                <div class="stats-text">
                    <strong>Daily Momentum</strong>
                    <span>{{ dailyNotes().length }} thoughts today</span>
                </div>
            </div>
        </div>

        <div class="notes-section custom-scrollbar">
            <div class="notes-header">
                <span class="day-label">{{ selectedDate() | date:'EEEE, MMM d' }}</span>
                <span class="count-label">{{ dailyNotes().length }} Entries</span>
            </div>

            @if (dailyNotes().length === 0) {
                <div class="empty-state-mini">
                    <i class="pi pi-pencil"></i>
                    <p>Quiet day. Capture a thought?</p>
                    <button class="btn-link" (click)="openNewNote()">New Entry</button>
                </div>
            } @else {
                <div class="notes-list">
                    @for (note of dailyNotes(); track note._id) {
                        <div class="note-item" [class.pinned]="note.isPinned" (click)="viewNote(note)">
                            <div class="note-top">
                                <span class="time">{{ note.noteDate | date:'shortTime' }}</span>
                                <div class="badges">
                                    @if(note.isPinned) { <i class="pi pi-bookmark-fill pin"></i> }
                                    @if(note.importance === 'high') { <span class="badge-high">High</span> }
                                </div>
                            </div>
                            <h4>{{ note.title || 'Untitled' }}</h4>
                            <p>{{ note.content }}</p>
                            @if(note.tags?.length) {
                                <div class="tags-row">
                                    @for(tag of note.tags; track tag) { <span>#{{tag}}</span> }
                                </div>
                            }
                        </div>
                    }
                </div>
            }
        </div>
      </div>
    }

    @if (activeView() === 'archive') {
        <div class="archive-layout animate-fade-up">
            
            <div class="archive-controls">
                <div class="search-input">
                    <i class="pi pi-search"></i>
                    <input type="text" placeholder="Search notes..." 
                           [value]="searchQuery()" (input)="searchQuery.set($any($event.target).value)">
                </div>

                <div class="filter-select">
                    <select [value]="filterTag()" (change)="filterTag.set($any($event.target).value)">
                        <option value="all">All Tags</option>
                        @for (tag of allTags(); track tag) { <option [value]="tag">{{ tag }}</option> }
                    </select>
                </div>

                <button class="btn-icon" (click)="toggleViewMode()">
                    <i class="pi" [class.pi-th-large]="viewMode() === 'list'" [class.pi-list]="viewMode() === 'grid'"></i>
                </button>
            </div>
            
            <div class="archive-content custom-scrollbar">
                @for (group of notesGroupedByMonth(); track group.monthKey) {
                    <section class="month-group">
                        <h3 class="month-header">
                            {{ group.monthName }}
                            <span class="count">{{ group.notes.length }} notes</span>
                        </h3>

                        <div class="archive-grid" [class.list-mode]="viewMode() === 'list'">
                            @for (note of group.notes; track note._id) {
                                <div class="archive-card" (click)="viewNote(note)">
                                    <div class="card-top">
                                        <span class="date">{{ note.noteDate | date:'MMM d' }}</span>
                                        <div class="actions">
                                            <button (click)="editNote(note); $event.stopPropagation()"><i class="pi pi-pencil"></i></button>
                                            <button class="danger" (click)="deleteNote(note); $event.stopPropagation()"><i class="pi pi-trash"></i></button>
                                        </div>
                                    </div>
                                    <h4>{{ note.title }}</h4>
                                    <p>{{ note.content }}</p>
                                    @if(note.attachments.length) {
                                        <div class="attach-badge"><i class="pi pi-paperclip"></i> {{note.attachments.length}}</div>
                                    }
                                </div>
                            }
                        </div>
                    </section>
                } @empty {
                    <div class="empty-state-mini">
                        <p>No notes found matching your filters.</p>
                    </div>
                }
            </div>
        </div>
    }
  </div>
</div>

<p-dialog [(visible)]="isEditorVisible" [modal]="true" [style]="{width: '600px'}" 
          styleClass="erp-dialog" [draggable]="false" [resizable]="false">
    
    <ng-template pTemplate="header">
        <div class="dialog-header-custom">
            <div class="date-badge">{{ selectedDate() | date:'fullDate' }}</div>
            <button class="btn-icon-soft" (click)="toggleEditMode()">
                <i class="pi" [class.pi-pencil]="isPreviewMode" [class.pi-eye]="!isPreviewMode"></i>
            </button>
        </div>
    </ng-template>

    <div class="dialog-body">
        <form [formGroup]="noteForm">
            @if(!isPreviewMode) {
                <input class="modern-input title-input" formControlName="title" placeholder="Title your thought...">
                
                <div class="toolbar">
                     <div class="tag-input-wrapper">
                        <p-autoComplete formControlName="tags" [multiple]="true" placeholder="+ Add tags" styleClass="w-full"></p-autoComplete>
                     </div>
                     
                     <button type="button" class="btn-media" (click)="triggerFileUpload()">
                        <i class="pi pi-image"></i> Media
                     </button>
                     <input #fileInput type="file" (change)="onFileSelect($event)" multiple accept="image/*" style="display: none;">
                </div>

                @if (imagePreviews.length) {
                    <div class="image-strip custom-scrollbar">
                        @for (img of imagePreviews; track $index) {
                            <div class="thumb">
                                <img [src]="img.url">
                                <button (click)="removeAttachment($index)">x</button>
                            </div>
                        }
                    </div>
                }

                <textarea class="modern-input body-input" formControlName="content" placeholder="Start writing..."></textarea>
            } @else {
                <h2 class="preview-title">{{ noteForm.get('title')?.value || 'Untitled' }}</h2>
                
                @if (noteForm.get('tags')?.value?.length) {
                    <div class="preview-tags">
                        @for (tag of noteForm.get('tags')?.value; track tag) { <span class="ptag">#{{tag}}</span> }
                    </div>
                }

                @if (imagePreviews.length) {
                    <div class="preview-gallery">
                        @for (img of imagePreviews; track $index) {
                            <img [src]="img.url">
                        }
                    </div>
                }

                <p class="preview-body">{{ noteForm.get('content')?.value }}</p>
            }
        </form>
    </div>

    <ng-template pTemplate="footer">
        <div class="footer-actions">
            <button class="btn-cancel" (click)="isEditorVisible=false">
                {{ isPreviewMode ? 'Close' : 'Discard' }}
            </button>

            @if (!isPreviewMode) {
                <button class="btn-save" (click)="saveNote()" [disabled]="isSaving">
                    @if(isSaving){ <i class="pi pi-spin pi-spinner"></i> }
                    {{ isSaving ? 'Saving...' : 'Save Entry' }}
                </button>
            }
        </div>
    </ng-template>
</p-dialog>
