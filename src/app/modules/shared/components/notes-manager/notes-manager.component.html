<p-toast position="bottom-right" zIndex="2000"></p-toast>

<div class="erp-glass-widget" 
     [style.transform]="'perspective(1000px) rotateX(' + rotateX() + 'deg) rotateY(' + rotateY() + 'deg)'">
  
  <div class="noise-overlay"></div>

  <header class="widget-header">
    <div class="header-left">
      <div class="icon-box">
        <i class="pi pi-calendar-plus"></i>
      </div>
      <div>
        <h2>Journal & Tasks</h2>
        <span class="subtitle">Daily Overview</span>
      </div>
    </div>

    <div class="nav-pills">
      <button class="nav-item" [class.active]="activeView() === 'calendar'" (click)="switchView('calendar')">Calendar</button>
      <button class="nav-item" [class.active]="activeView() === 'archive'" (click)="switchView('archive')">Archive</button>
    </div>

    <button class="btn-add-mini" (click)="openNewNote()" pTooltip="New Entry" tooltipPosition="left">
      <i class="pi pi-plus"></i>
    </button>
  </header>

  <div class="widget-body custom-scrollbar">

    @if (activeView() === 'calendar') {
      <div class="split-layout animate-fade-up">
        
        <div class="calendar-section">
            <div class="cal-controls">
                <button class="btn-text" (click)="changeMonth(-1)"><i class="pi pi-chevron-left"></i></button>
                <span class="current-month">{{ currentMonthName() }}</span>
                <button class="btn-text" (click)="changeMonth(1)"><i class="pi pi-chevron-right"></i></button>
                <button class="btn-today" (click)="jumpToToday()">Today</button>
            </div>

            <div class="cal-grid-header">
                @for (day of ['S', 'M', 'T', 'W', 'T', 'F', 'S']; track day) {
                    <span>{{ day }}</span>
                }
            </div>

            <div class="cal-grid">
                @for (day of calendarDays(); track $index) {
                    <div class="cal-day" 
                         [class.faded]="!day.isCurrentMonth"
                         [class.today]="day.isToday"
                         [class.selected]="day.isSelected"
                         (click)="selectDay(day)">
                        
                        <span>{{ day.dayNum }}</span>
                        
                        @if(day.noteCount > 0) {
                            <div class="dot-indicator"></div>
                        }
                    </div>
                }
            </div>
        </div>

        <div class="notes-section custom-scrollbar">
            <div class="notes-header">
                <span class="day-label">{{ selectedDate() | date:'EEEE, MMM d' }}</span>
                <span class="count-label">{{ dailyNotes().length }} Entries</span>
            </div>

            @if (dailyNotes().length === 0) {
                <div class="empty-state-mini">
                    <i class="pi pi-book" style="font-size: 1.5rem; opacity: 0.3;"></i>
                    <p>No entries yet.</p>
                </div>
            } @else {
                <div class="notes-list">
                    @for (note of dailyNotes(); track note._id) {
                        <div class="note-item" (click)="viewNote(note)">
                            <div class="note-time">{{ note.noteDate | date:'shortTime' }}</div>
                            <div class="note-content">
                                <h4>{{ note.title }}</h4>
                                <p>{{ note.content }}</p>
                            </div>
                            @if(note.isPinned) { <i class="pi pi-paperclip pin-icon"></i> }
                        </div>
                    }
                </div>
            }
        </div>
      </div>
    }

    @if (activeView() === 'archive') {
        <div class="archive-layout animate-fade-up">
            <div class="search-bar">
                <i class="pi pi-search"></i>
                <input type="text" placeholder="Search past notes..." 
                       [value]="searchQuery()" (input)="searchQuery.set($any($event.target).value)">
                
                <select [value]="filterTag()" (change)="filterTag.set($any($event.target).value)">
                    <option value="all">All Tags</option>
                    @for (tag of allTags(); track tag) { <option [value]="tag">{{ tag }}</option> }
                </select>
            </div>
            
            <div class="archive-list custom-scrollbar">
                @for (note of filteredNotes(); track note._id) {
                    <div class="archive-item" (click)="viewNote(note)">
                        <span class="date">{{ note.noteDate | date:'MM/dd' }}</span>
                        <div class="info">
                            <span class="title">{{ note.title }}</span>
                            <span class="excerpt">{{ note.content | slice:0:50 }}...</span>
                        </div>
                        <span class="tags">
                            @for(tag of note.tags; track tag) { <span class="tag">#{{tag}}</span> }
                        </span>
                    </div>
                }
            </div>
        </div>
    }

  </div>
</div>

<p-dialog [(visible)]="isEditorVisible" [modal]="true" [style]="{width: '600px'}" 
          styleClass="erp-dialog" [draggable]="false" [resizable]="false">
    
    <ng-template pTemplate="header">
        <div class="dialog-header">
            <span class="dialog-date">{{ selectedDate() | date:'fullDate' }}</span>
            <button class="btn-icon" (click)="toggleEditMode()">
                <i class="pi" [class.pi-pencil]="isPreviewMode" [class.pi-eye]="!isPreviewMode"></i>
            </button>
        </div>
    </ng-template>

    <div class="dialog-body" [class.preview]="isPreviewMode">
        <form [formGroup]="noteForm">
            @if(!isPreviewMode) {
                <input class="modern-input title-input" formControlName="title" placeholder="Title">
                
                <div class="toolbar">
                     <p-autoComplete formControlName="tags" [multiple]="true" placeholder="+ Tags" styleClass="w-full"></p-autoComplete>
                     <button type="button" class="btn-media" (click)="triggerFileUpload()"><i class="pi pi-image"></i></button>
                     <input #fileInput type="file" (change)="onFileSelect($event)" multiple accept="image/*" style="display: none;">
                </div>

                @if (imagePreviews.length) {
                    <div class="image-strip custom-scrollbar">
                        @for (img of imagePreviews; track $index) {
                            <div class="thumb">
                                <img [src]="img.url">
                                <button (click)="removeAttachment($index)">x</button>
                            </div>
                        }
                    </div>
                }

                <textarea class="modern-input body-input" formControlName="content" placeholder="Write here..."></textarea>
            } @else {
                <h2>{{ noteForm.get('title')?.value }}</h2>
                <p style="white-space: pre-wrap; line-height: 1.6;">{{ noteForm.get('content')?.value }}</p>
                
                @if (imagePreviews.length) {
                    <div class="image-grid">
                        @for (img of imagePreviews; track $index) {
                            <img [src]="img.url" class="img-preview">
                        }
                    </div>
                }
            }
        </form>
    </div>

    <ng-template pTemplate="footer">
        @if(!isPreviewMode) {
            <button class="btn-save" (click)="saveNote()" [disabled]="isSaving">
                {{ isSaving ? 'Saving...' : 'Save Entry' }}
            </button>
        }
    </ng-template>
</p-dialog><!-- <p-toast position="bottom-right" zIndex="2000"></p-toast>

<section class="notes-container">
  <div class="bg-decoration">
    <div class="blob blob-1"></div>
    <div class="blob blob-2"></div>
    <div class="blob blob-3"></div>
  </div>

  <div class="content-wrapper">
    <header class="app-header">
      <div class="header-left">
        <div class="logo-section">
          <div class="logo-icon">
            <i class="pi pi-book"></i>
          </div>
          <h1 class="app-title">My Journal</h1>
        </div>

        <nav class="view-tabs">
          <button class="tab-btn" [class.active]="activeView() === 'calendar'" (click)="switchView('calendar')">
            <i class="pi pi-calendar"></i>
            <span>Calendar</span>
          </button>
          <button class="tab-btn" [class.active]="activeView() === 'archive'" (click)="switchView('archive')">
            <i class="pi pi-database"></i>
            <span>Archive</span>
          </button>
        </nav>
      </div>

      <button class="btn-new-note" (click)="openNewNote()" pTooltip="Create New Note" tooltipPosition="bottom">
        <i class="pi pi-plus"></i>
        <span>New Entry</span>
      </button>
    </header>

    @if (activeView() === 'calendar') {
    <div class="view-content animate-fade-in">
      <div class="calendar-layout">
        <aside class="sidebar-notes">
          <div class="sidebar-header">
            <div class="date-info">
              <h2 class="day-name">{{ selectedDate() | date:'EEEE' }}</h2>
              <p class="date-full">{{ selectedDate() | date:'MMMM d, y' }}</p>
            </div>
          </div>

          <div class="notes-list custom-scrollbar">
            @for (note of dailyNotes(); track note._id) {
            <article class="note-card" [class.pinned]="note.isPinned" (click)="viewNote(note)">
              <div class="note-header-row">
                <span class="note-time">
                  <i class="pi pi-clock"></i>
                  {{ note.noteDate | date:'shortTime' }}
                </span>
                <div class="priority-badges">
                  @if(note.isPinned) { <i class="pi pi-bookmark-fill pinned-icon"></i> }
                  @if(note.importance === 'high') { <span class="p-badge p-badge-danger">High</span> }
                </div>
              </div>

              <h3 class="note-title">{{ note.title || 'Untitled Entry' }}</h3>
              <p class="note-excerpt">{{ note.content }}</p>

              @if (note.tags?.length) {
              <div class="note-tags">
                @for (tag of note.tags; track tag) {
                <span class="tag-chip">#{{tag}}</span>
                }
              </div>
              }
            </article>
            } @empty {
            <div class="empty-state">
              <div class="empty-illustration">
                <i class="pi pi-pencil"></i>
              </div>
              <p>A quiet day. No entries yet.</p>
              <button class="btn-outline-sm" (click)="openNewNote()">Capture a thought</button>
            </div>
            }
          </div>
        </aside>

        <main class="calendar-main">
          <div class="calendar-card">
            <div class="calendar-controls">
              <div class="month-nav">
                <button class="btn-icon-round" (click)="changeMonth(-1)"><i class="pi pi-chevron-left"></i></button>
                <h3 class="month-title">{{ currentMonthName() }}</h3>
                <button class="btn-icon-round" (click)="changeMonth(1)"><i class="pi pi-chevron-right"></i></button>
              </div>
              <button class="btn-today-alt" (click)="jumpToToday()">Today</button>
            </div>

            <div class="calendar-grid">
              @for (day of ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat']; track day) {
              <div class="calendar-header-cell">{{ day }}</div>
              }

              @for (day of calendarDays(); track $index) {
              <div class="calendar-day" [class.other-month]="!day.isCurrentMonth" [class.today]="day.isToday"
                [class.selected]="day.isSelected" (click)="selectDay(day)">

                <span class="day-number">{{ day.dayNum }}</span>

                @if (day.noteCount > 0) {
                <div class="day-indicators">
                  @for (item of getIndicators(day.noteCount); track $index) {
                  <span class="dot-indicator" [style.opacity]="1 - ($index * 0.2)"></span>
                  }
                </div>
                }
              </div>
              }
            </div>
          </div>

          <div class="stats-card-modern">
            <div class="stats-icon-bg"><i class="pi pi-bolt"></i></div>
            <div class="stats-info">
              <h4>Daily Momentum</h4>
              <p>You've captured <strong>{{ dailyNotes().length }}</strong> thoughts today.</p>
            </div>
            <div class="stats-visual">
              <div class="progress-bar-mini">
                <div [style.width.%]="(dailyNotes().length / 5) * 100"></div>
              </div>
            </div>
          </div>
        </main>
      </div>
    </div>
    }
    @if (activeView() === 'archive') {
    <div class="view-content">
      Archive Controls
      <div class="archive-controls">
        <div class="search-box">
          <i class="pi pi-search"></i>
          <input type="text" placeholder="Search notes..." [value]="searchQuery()"
            (input)="searchQuery.set($any($event.target).value)">
        </div>

        <div class="filter-select" style="position: relative;">
          <i class="pi pi-tag"
            style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-tertiary); pointer-events: none;"></i>
          <select [value]="filterTag()" (change)="filterTag.set($any($event.target).value)"
            style="padding-left: 36px; height: 100%; border: 1px solid var(--border-secondary); border-radius: 8px; background: var(--bg-primary); color: var(--text-primary); cursor: pointer;">
            <option value="all">All Tags</option>
            @for (tag of allTags(); track tag) {
            <option [value]="tag">{{ tag }}</option>
            }
          </select>
        </div>

        <button class="btn-new-note"
          style="background: white; color: var(--text-secondary); border: 1px solid var(--border-secondary); box-shadow: none;"
          (click)="toggleViewMode()" pTooltip="Toggle View">
          <i class="pi" [class.pi-th-large]="viewMode() === 'list'" [class.pi-list]="viewMode() === 'grid'"></i>
        </button>
      </div>
      <div class="archive-content mt-2">
        @for (group of notesGroupedByMonth(); track group.monthKey) {
        <section class="month-section">
          <h3
            style="font-family: var(--font-heading); font-size: var(--font-size-lg); font-weight: 700; color: var(--text-secondary); margin-bottom: 1rem; display: flex; align-items: center; gap: 8px;">
            <i class="pi pi-calendar" style="color: var(--accent-primary);"></i>
            {{ group.monthName }}
            <span style="margin-left: auto; font-size: 0.8rem; font-weight: 400; color: var(--text-tertiary);">{{
              group.notes.length }} notes</span>
          </h3>

          <div class="notes-grid"
            [style.grid-template-columns]="viewMode() === 'list' ? '1fr' : 'repeat(auto-fill, minmax(300px, 1fr))'">
            @for (note of group.notes; track note._id) {
            <article class="archive-note-card">
              <div class="card-header">
                <span class="card-date">{{ note.createdAt | date:'MMM d' }}</span>
                <div class="card-actions" style="display: flex; gap: 4px;">
                  <button class="btn-icon"
                    style="width: 24px; height: 24px; border: none; background: transparent; cursor: pointer; color: var(--text-tertiary);"
                    (click)="editNote(note); $event.stopPropagation()">
                    <i class="pi pi-pencil" style="font-size: 12px;"></i>
                  </button>
                  <button class="btn-icon"
                    style="width: 24px; height: 24px; border: none; background: transparent; cursor: pointer; color: var(--color-error);"
                    (click)="deleteNote(note); $event.stopPropagation()">
                    <i class="pi pi-trash" style="font-size: 12px;"></i>
                  </button>
                </div>
              </div>

              <h4 class="card-title" (click)="viewNote(note)">{{ note.title || 'Untitled' }}</h4>
              <p class="card-content">{{ note.content }}</p>

              <div
                style="margin-top: auto; padding-top: 12px; border-top: 1px solid var(--border-primary); display: flex; gap: 8px;">
                @if(note.attachments.length) {
                <span
                  style="font-size: 10px; color: var(--text-tertiary); display: flex; align-items: center; gap: 4px;">
                  <i class="pi pi-paperclip"></i> {{ note.attachments.length }}
                </span>
                }
              </div>
            </article>
            }
          </div>
        </section>
        } @empty {
        <div class="empty-state">
          <i class="pi pi-inbox"></i>
          <h3>No notes found</h3>
          <p>Try adjusting your search or filters</p>
        </div>
        }
      </div>
    </div>
    }
 </div>
</section>
<p-dialog [(visible)]="isEditorVisible" [modal]="true" [style]="{width: '90vw', maxWidth: '800px', height: 'auto'}"
  [showHeader]="true" styleClass="editor-dialog" [draggable]="false" [resizable]="false" [closeOnEscape]="false">
  <ng-template pTemplate="header">
    <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
      <div style="display: flex; align-items: center; gap: 12px;">
        <span
          style="font-size: 0.8rem; font-weight: 600; color: var(--text-tertiary); text-transform: uppercase; letter-spacing: 0.05em;">
          {{ selectedDate() | date:'fullDate' }}
        </span>
        @if (isSaving) {
        <span style="font-size: 0.75rem; color: var(--accent-primary); display: flex; align-items: center; gap: 4px;">
          <i class="pi pi-spin pi-spinner"></i> Saving...
        </span>
        }
      </div>

      <button class="btn-icon"
        style="width: 32px; height: 32px; border: 1px solid var(--border-secondary); background: transparent; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center;"
        (click)="toggleEditMode()" [pTooltip]="isPreviewMode ? 'Edit' : 'Preview'">
        <i class="pi" [class.pi-pencil]="isPreviewMode" [class.pi-eye]="!isPreviewMode"></i>
      </button>
    </div>
  </ng-template>

  <div class="editor-content" [class.preview-mode]="isPreviewMode" style="padding: 0;">
    <form [formGroup]="noteForm">

      @if (!isPreviewMode) {
      <input type="text" formControlName="title" class="editor-title" placeholder="Title your thought..." />

      Toolbar
      <div
        style="display: flex; gap: 12px; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid var(--border-primary);">
        <div style="flex: 1;">
          <p-autoComplete formControlName="tags" [multiple]="true" placeholder="+ Add tags"
            styleClass="w-full"></p-autoComplete>
        </div>

        <button type="button"
          style="display: flex; align-items: center; gap: 8px; padding: 8px 16px; border: 1px solid var(--border-secondary); background: var(--bg-ternary); border-radius: 6px; cursor: pointer; color: var(--text-secondary); font-size: 0.85rem;"
          (click)="triggerFileUpload()">
          <i class="pi pi-image"></i>
          <span>Media</span>
        </button>
        <input #fileInput type="file" (change)="onFileSelect($event)" multiple accept="image/*" style="display: none;">
      </div>

      @if (imagePreviews.length > 0) {
      <div style="display: flex; gap: 12px; overflow-x: auto; padding-bottom: 12px; margin-bottom: 16px;">
        @for (img of imagePreviews; track $index) {
        <div
          style="position: relative; flex-shrink: 0; width: 100px; height: 100px; border-radius: 8px; overflow: hidden; border: 1px solid var(--border-secondary);">
          <img [src]="img.url" alt="Preview" style="width: 100%; height: 100%; object-fit: cover;">
          <button (click)="removeAttachment($index)"
            style="position: absolute; top: 4px; right: 4px; width: 20px; height: 20px; border-radius: 50%; background: white; border: none; color: red; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <i class="pi pi-times" style="font-size: 10px;"></i>
          </button>
        </div>
        }
      </div>
      }

      <textarea formControlName="content" class="editor-textarea"
        placeholder="Start writing your story here..."></textarea>
      } @else {
      <h2
        style="font-family: var(--font-heading); font-size: 1.75rem; font-weight: 700; color: var(--text-primary); margin-bottom: 1rem;">
        {{ noteForm.get('title')?.value || 'Untitled' }}
      </h2>

      @if (noteForm.get('tags')?.value?.length) {
      <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 24px;">
        @for (tag of noteForm.get('tags')?.value; track tag) {
        <span
          style="background: var(--accent-focus); color: var(--accent-primary); padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 500;">#{{tag}}</span>
        }
      </div>
      }

      @if (imagePreviews.length > 0) {
      <div
        style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px; margin-bottom: 24px;">
        @for (img of imagePreviews; track $index) {
        <img [src]="img.url" alt="Attachment"
          style="width: 100%; height: 200px; object-fit: cover; border-radius: 8px; border: 1px solid var(--border-secondary);">
        }
      </div>
      }

      <div style="font-size: 1rem; line-height: 1.6; color: var(--text-primary); white-space: pre-wrap;">
        {{ noteForm.get('content')?.value }}
      </div>
      }
    </form>
  </div>
  <ng-template pTemplate="footer">
    <div style="display: flex; justify-content: flex-end; gap: 12px; align-items: center;">
      <button class="btn-secondary"
        style="padding: 10px 20px; border: 1px solid var(--border-secondary); background: white; border-radius: 8px; cursor: pointer; color: var(--text-secondary); font-weight: 600;"
        (click)="isEditorVisible=false">
        {{ isPreviewMode ? 'Close' : 'Discard' }}
      </button>

      @if (!isPreviewMode) {
      <button class="btn-primary"
        style="padding: 10px 24px; border: none; background: var(--accent-gradient); border-radius: 8px; cursor: pointer; color: white; font-weight: 600; display: flex; align-items: center; gap: 8px; box-shadow: var(--shadow-lg);"
        (click)="saveNote()" [disabled]="isSaving">
        <i class="pi" [class.pi-save]="!isSaving" [class.pi-spin]="isSaving" [class.pi-spinner]="isSaving"></i>
        <span>{{ isSaving ? 'Saving...' : 'Save Entry' }}</span>
      </button>
      }
    </div>
  </ng-template>
</p-dialog> -->
