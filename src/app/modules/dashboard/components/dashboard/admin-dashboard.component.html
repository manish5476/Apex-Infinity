<div class="dashboard-container animate-fadeIn">
  <header class="dashboard-header">
    <div class="header-content">
      <h1 class="page-title">Executive Overview</h1>
      <p class="page-subtitle">
        Snapshot of your sales, cashflow and risk.
      </p>
    </div>

    <div class="header-actions">
      
      <div class="header-filters">
        <div class="preset-group">
          <button class="filter-chip" [class.active]="activePreset() === 'all'" (click)="applyPreset('all')">
            All Time
          </button>
          <button class="filter-chip" [class.active]="activePreset() === 'month'" (click)="applyPreset('month')">
            This Month
          </button>
        </div>

        <div class="date-range-wrapper">
          <p-datepicker selectionMode="range" [showIcon]="true" [maxDate]="today" dateFormat="yy-mm-dd"
            [(ngModel)]="dateRangeModel" (onSelect)="onDateRangeChange()" appendTo="body"
            styleClass="w-full" inputStyleClass="w-full" placeholder="Custom Range"
            inputId="dashboardDateRange"></p-datepicker>
        </div>
      </div>

      <div class="action-buttons">
        <p-button label="Download" icon="pi pi-download" styleClass="p-button-outlined p-button-sm w-full"></p-button>
        <p-button label="Refresh" icon="pi pi-refresh" (onClick)="loadDashboard()" [loading]="loading()" styleClass="p-button-sm w-full"></p-button>
      </div>
    </div>
  </header>

  @if (loading()) {
    <div class="grid-layout">
      <p-skeleton height="10rem" borderRadius="12px" styleClass="w-full"></p-skeleton>
      <p-skeleton height="10rem" borderRadius="12px" styleClass="w-full"></p-skeleton>
      <p-skeleton height="10rem" borderRadius="12px" styleClass="w-full"></p-skeleton>
      <p-skeleton height="10rem" borderRadius="12px" styleClass="w-full"></p-skeleton>
    </div>
  } @else {

  <section class="grid-layout kpi-section">
    
    <div class="glass-card kpi-card">
      <div class="kpi-top">
        <div class="icon-wrapper accent-wrapper"><i class="pi pi-wallet"></i></div>
        <span class="trend-badge positive"><i class="pi pi-arrow-up"></i> This period</span>
      </div>
      <div class="kpi-content">
        <span class="kpi-label">Total Revenue</span>
        <h3 class="kpi-value">{{ common.formatCurrency(totalSales()) }}</h3>
        <p class="kpi-sub">Income: {{ common.formatCurrency(income()) }}</p>
      </div>
    </div>

    <div class="glass-card kpi-card">
      <div class="kpi-top">
        <div class="icon-wrapper success-wrapper"><i class="pi pi-percentage"></i></div>
        <span class="trend-badge" [class.positive]="netProfit() > 0" [class.negative]="netProfit() < 0" [class.neutral]="netProfit() === 0">
          <i class="pi" [class.pi-arrow-up]="netProfit() > 0" [class.pi-arrow-down]="netProfit() < 0" [class.pi-minus]="netProfit() === 0"></i>
          {{ netProfit() > 0 ? 'Profitable' : 'Loss' }}
        </span>
      </div>
      <div class="kpi-content">
        <span class="kpi-label">Net Profit</span>
        <h3 class="kpi-value">{{ common.formatCurrency(netProfit()) }}</h3>
        <p class="kpi-sub">Exp: {{ common.formatCurrency(totalExpenses()) }}</p>
      </div>
    </div>

    <div class="glass-card kpi-card">
      <div class="kpi-top">
        <div class="icon-wrapper info-wrapper"><i class="pi pi-arrow-down-left"></i></div>
        <span class="trend-badge neutral"><i class="pi pi-check-circle"></i> Cash In</span>
      </div>
      <div class="kpi-content">
        <span class="kpi-label">Total Receipts</span>
        <h3 class="kpi-value">{{ common.formatCurrency(totalReceipts()) }}</h3>
        <p class="kpi-sub">Collected</p>
      </div>
    </div>

    <div class="glass-card kpi-card">
      <div class="kpi-top">
        <div class="icon-wrapper info-wrapper"><i class="pi pi-file"></i></div>
        <span class="trend-badge neutral"><i class="pi pi-send"></i> Billed</span>
      </div>
      <div class="kpi-content">
        <span class="kpi-label">Invoices</span>
        <h3 class="kpi-value">{{ invoiceCount() }}</h3>
        <p class="kpi-sub">Due: {{ common.formatCurrency(outstandingReceivables()) }}</p>
      </div>
    </div>

    <div class="glass-card kpi-card">
      <div class="kpi-top">
        <div class="icon-wrapper warning-wrapper"><i class="pi pi-database"></i></div>
        <span class="trend-badge neutral"><i class="pi pi-box"></i> Stock</span>
      </div>
      <div class="kpi-content">
        <span class="kpi-label">Inventory Value</span>
        <h3 class="kpi-value">{{ common.formatCurrency(stockValue()) }}</h3>
        <p class="kpi-sub">{{ stockQty() }} Units</p>
      </div>
    </div>

    <div class="glass-card kpi-card">
      <div class="kpi-top">
        <div class="icon-wrapper accent-wrapper"><i class="pi pi-users"></i></div>
        <span class="trend-badge neutral"><i class="pi pi-user"></i> Active</span>
      </div>
      <div class="kpi-content">
        <span class="kpi-label">Parties</span>
        <h3 class="kpi-value">{{ totalCustomers() + totalSuppliers() }}</h3>
        <p class="kpi-sub">{{ totalCustomers() }} Cust Â· {{ totalSuppliers() }} Supp</p>
      </div>
    </div>
  </section>

  <section class="main-content-grid">
    
    <div class="glass-card chart-section">
      <div class="card-header">
        <div>
          <h3>Revenue Trend</h3>
          <span class="text-xs text-secondary">Last 6 months</span>
        </div>
      </div>
      <div class="chart-wrapper">
        <p-chart type="bar" [data]="chartData()" [options]="chartOptions()" height="100%"></p-chart>
      </div>
    </div>

    <div class="glass-card rankings-section">
      <div class="card-header card-header--split">
        <h3>Top Performers</h3>
        <div class="ranking-tabs">
          <button class="ranking-tab" [class.active]="activeRankingTab() === 'products'" (click)="setRankingTab('products')">Products</button>
          <button class="ranking-tab" [class.active]="activeRankingTab() === 'customers'" (click)="setRankingTab('customers')">Customers</button>
        </div>
      </div>

      <div class="table-responsive-wrapper">
        <p-table [value]="activeRankingTab() === 'products' ? topProducts() : topCustomers()" styleClass="p-datatable-sm p-datatable-gridlines">
          <ng-template pTemplate="header">
            <tr>
              <th style="width: 30px;">#</th>
              <th>Name</th>
              <th class="text-right">Total</th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-item let-rowIndex="rowIndex">
            <tr>
              <td class="text-center"><span class="rank-badge">{{ rowIndex + 1 }}</span></td>
              <td>
                <div class="font-medium text-sm truncate" style="max-width: 140px;">
                  {{ activeRankingTab() === 'products' ? item.productName : item.customerName }}
                </div>
              </td>
              <td class="text-right font-bold text-xs text-primary">
                {{ common.formatCurrency(activeRankingTab() === 'products' ? item.totalRevenue : item.totalSpent) }}
              </td>
            </tr>
          </ng-template>
          <ng-template pTemplate="emptymessage">
            <tr><td colspan="3" class="text-center p-4 text-xs">No data available</td></tr>
          </ng-template>
        </p-table>
      </div>
    </div>
  </section>

  <section class="glass-card mt-md receivables-section">
    <div class="card-header receivables-header">
      <div>
        <h3>Outstanding Receivables</h3>
        <span class="text-xs text-secondary">Pending: {{ common.formatCurrency(outstandingReceivables()) }}</span>
      </div>
      <div class="hidden-mobile">
        <span class="badge-pill badge-danger"><i class="pi pi-info-circle"></i> Unpaid Invoices</span>
      </div>
    </div>

    <div class="table-responsive-wrapper">
      <p-table [value]="receivables()" [rows]="5" [paginator]="true" styleClass="p-datatable-sm">
        <ng-template pTemplate="header">
          <tr>
            <th>Customer</th>
            <th class="hidden-mobile">Phone</th>
            <th class="hidden-mobile">Invoiced</th>
            <th class="text-right">Due Amount</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-item>
          <tr>
            <td class="font-medium">
              {{ item.party?.name }}
              <div class="visible-mobile text-xs text-secondary">{{ item.party?.phone }}</div>
            </td>
            <td class="hidden-mobile text-xs">{{ item.party?.phone }}</td>
            <td class="hidden-mobile text-xs">{{ common.formatCurrency(item.invoiced) }}</td>
            <td class="text-right font-bold text-error">{{ common.formatCurrency(item.outstanding) }}</td>
          </tr>
        </ng-template>
        <ng-template pTemplate="emptymessage">
          <tr><td colspan="4" class="text-center p-4 text-xs">No pending payments.</td></tr>
        </ng-template>
      </p-table>
    </div>
  </section>
  }
</div>
