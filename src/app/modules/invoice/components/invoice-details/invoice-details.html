<p-toast></p-toast>
<p-confirmDialog></p-confirmDialog>

<div class="page-container w-full max-w-full p-4" style="zoom: 0.95;">

  @if (isLoading()) {
    <!-- Skeleton Loader -->
    <div class="space-y-4">
      <div class="flex justify-between">
        <div class="flex gap-4">
          <p-skeleton size="3rem" shape="circle"></p-skeleton>
          <div>
            <p-skeleton width="10rem" height="1.5rem" styleClass="mb-2"></p-skeleton>
            <p-skeleton width="6rem" height="1rem"></p-skeleton>
          </div>
        </div>
        <p-skeleton width="8rem" height="2.5rem"></p-skeleton>
      </div>
      <p-skeleton height="12rem" styleClass="w-full"></p-skeleton>
    </div>
  } @else if (invoice(); as inv) {

    <!-- HEADER -->
    <header class="bg-[var(--bg-primary)] p-6 rounded-xl border border-[var(--border-secondary)] shadow-sm mb-6">
      <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
        
        <div class="flex items-center gap-4">
          <button pButton icon="pi pi-arrow-left" class="p-button-text p-button-rounded p-button-secondary" routerLink="/invoices"></button>
          <div>
            <div class="flex items-center gap-3">
              <h1 class="text-2xl font-bold text-[var(--text-primary)] m-0">#{{ inv.invoiceNumber }}</h1>
              <!-- Invoice Status -->
              <p-tag [value]="inv.status | uppercase" [severity]="common.mapStatusToSeverity(inv.status)"></p-tag>
              <!-- Payment Status -->
              @if (inv.status !== 'cancelled') {
                <p-tag [value]="inv.paymentStatus | uppercase" [severity]="getPaymentSeverity(inv.paymentStatus)"></p-tag>
              }
            </div>
            <div class="text-sm text-[var(--text-secondary)] mt-1 flex gap-3">
              <span><i class="pi pi-calendar mr-1"></i> Issued: {{ inv.invoiceDate | date:'mediumDate' }}</span>
              <span><i class="pi pi-clock mr-1"></i> Due: {{ inv.dueDate | date:'mediumDate' }}</span>
            </div>
          </div>
        </div>

        <div class="flex flex-wrap gap-2">
          <!-- EMI Action (if available) -->
          @if (existingEmiId()) {
            <button pButton label="View EMI" icon="pi pi-percentage" class="p-button-outlined p-button-help p-button-sm"
              [routerLink]="['/emis', existingEmiId()]"></button>
          } @else if (inv.status !== 'cancelled' && inv.paymentStatus !== 'paid') {
            <button pButton label="Convert to EMI" icon="pi pi-calculator" class="p-button-outlined p-button-secondary p-button-sm"
              [routerLink]="['/emis/create']" [queryParams]="{invoiceId: inv._id}"></button>
          }

          <!-- Payment Action (if not paid/cancelled) -->
          @if (inv.status !== 'cancelled' && inv.balanceAmount > 0) {
            <button pButton label="Record Payment" icon="pi pi-wallet" class="p-button-success p-button-sm shadow-md"
              (click)="openPaymentModal()"></button>
          }

          <!-- Utility Actions -->
          <button pButton icon="pi pi-envelope" class="p-button-text p-button-secondary p-button-sm" 
            pTooltip="Email to Customer" (click)="onEmail()" [loading]="isProcessing()"></button>
          
          <button pButton icon="pi pi-download" class="p-button-text p-button-secondary p-button-sm" 
            pTooltip="Download PDF" (click)="onDownload()" [loading]="isProcessing()"></button>

          <!-- Cancel Action -->
          @if (inv.status !== 'cancelled') {
            <button pButton label="Cancel Invoice" icon="pi pi-times-circle" class="p-button-danger p-button-outlined p-button-sm"
              (click)="openCancelModal()"></button>
          }
        </div>
      </div>
    </header>

    <!-- CONTENT GRID (Replacing TabView) -->
    <main class="grid grid-cols-12 gap-6">
      
      <!-- LEFT COLUMN: Details & Items -->
      <div class="col-span-12 lg:col-span-8 space-y-6">
        
        <!-- Info Cards -->
        <section class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <!-- From -->
          <div class="bg-[var(--bg-secondary)] p-4 rounded-lg border border-[var(--border-secondary)]">
            <div class="text-xs uppercase font-bold text-[var(--text-ternary)] mb-2 tracking-wider">Billed From</div>
            <div class="font-bold text-[var(--text-primary)]">{{ inv.branchId?.name || 'Head Office' }}</div>
            <div class="text-sm text-[var(--text-secondary)] mt-1 whitespace-pre-line">
              {{ inv.branchId?.address?.street }}, {{ inv.branchId?.address?.city }}
              {{ inv.branchId?.address?.state }} - {{ inv.branchId?.address?.zipCode }}
            </div>
          </div>

          <!-- To -->
          <div class="bg-[var(--bg-secondary)] p-4 rounded-lg border border-[var(--border-secondary)]">
            <div class="text-xs uppercase font-bold text-[var(--text-ternary)] mb-2 tracking-wider">Billed To</div>
            <div class="font-bold text-[var(--accent-primary)] text-lg">{{ inv.customerId?.name }}</div>
            <div class="text-sm text-[var(--text-secondary)] mt-1">
              <div><i class="pi pi-envelope text-xs mr-1"></i> {{ inv.customerId?.email }}</div>
              <div><i class="pi pi-phone text-xs mr-1"></i> {{ inv.customerId?.phone }}</div>
            </div>
            <div class="text-sm text-[var(--text-primary)] mt-2 opacity-80">{{ inv.billingAddress || 'Address not provided' }}</div>
          </div>
        </section>

        <!-- Items Table -->
        <section class="bg-[var(--bg-primary)] rounded-lg border border-[var(--border-secondary)] overflow-hidden shadow-sm">
          <p-table [value]="inv.items" styleClass="p-datatable-sm" responsiveLayout="scroll">
            <ng-template pTemplate="header">
              <tr class="bg-[var(--bg-ternary)] text-xs uppercase">
                <th style="width: 40%">Item & Description</th>
                <th class="text-right">Qty</th>
                <th class="text-right">Price</th>
                <th class="text-right">Disc.</th>
                <th class="text-right">Tax</th>
                <th class="text-right">Amount</th>
              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-item>
              <tr>
                <td>
                  <div class="font-medium text-[var(--text-primary)]">{{ item.name }}</div>
                  @if(item.hsnCode) { <div class="text-xs text-[var(--text-ternary)] font-mono">HSN: {{ item.hsnCode }}</div> }
                </td>
                <td class="text-right font-mono">{{ item.quantity }} <span class="text-[10px] text-[var(--text-ternary)]">{{ item.unit }}</span></td>
                <td class="text-right">{{ item.price | currency:'INR' }}</td>
                <td class="text-right text-red-500">-{{ item.discount | currency:'INR' }}</td>
                <td class="text-right text-[var(--text-secondary)]">{{ item.taxRate }}%</td>
                <td class="text-right font-bold text-[var(--text-primary)]">
                  {{ (((item.quantity * item.price) - item.discount) * (1 + item.taxRate/100)) | currency:'INR' }}
                </td>
              </tr>
            </ng-template>
          </p-table>
        </section>

        <!-- Payment History Section -->
        @if (payments().length > 0) {
          <section class="bg-[var(--bg-primary)] rounded-lg border border-[var(--border-secondary)] p-4">
            <h3 class="text-sm font-bold text-[var(--text-secondary)] uppercase mb-3 border-b border-[var(--border-secondary)] pb-2 flex justify-between items-center">
              <span>Payment History</span>
              <span class="text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded-full">{{ payments().length }} Transactions</span>
            </h3>
            <div class="space-y-3">
              @for (pay of payments(); track pay._id) {
                <div class="flex justify-between items-center text-sm p-3 bg-[var(--bg-ternary)] rounded border border-[var(--border-secondary)]">
                  <div class="flex flex-col">
                    <span class="font-bold text-[var(--text-primary)]">{{ pay.paymentMethod | titlecase }}</span>
                    <span class="text-xs text-[var(--text-ternary)]">{{ pay.paymentDate | date:'medium' }}</span>
                  </div>
                  <div class="text-right">
                    <span class="font-bold text-green-600 block">+ {{ pay.amount | currency:'INR' }}</span>
                    @if (pay.transactionId) {
                      <span class="text-xs text-[var(--text-ternary)] font-mono">Ref: {{ pay.transactionId }}</span>
                    }
                  </div>
                </div>
              }
            </div>
          </section>
        }

      </div>

      <!-- RIGHT COLUMN: Summary & Notes -->
      <div class="col-span-12 lg:col-span-4 space-y-6">
        
        <!-- Totals Card -->
        <div class="bg-[var(--bg-secondary)] p-6 rounded-lg border border-[var(--border-primary)] shadow-sm sticky top-4">
          <h4 class="text-xs font-bold uppercase text-[var(--text-secondary)] mb-4">Financial Summary</h4>
          
          <div class="space-y-2 text-sm">
            <div class="flex justify-between">
              <span class="text-[var(--text-secondary)]">Subtotal</span>
              <span>{{ inv.subTotal | currency:'INR' }}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-[var(--text-secondary)]">Total Tax</span>
              <span class="text-green-600">+ {{ inv.totalTax | currency:'INR' }}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-[var(--text-secondary)]">Discount</span>
              <span class="text-red-500">- {{ inv.totalDiscount | currency:'INR' }}</span>
            </div>
            @if(inv.roundOff) {
              <div class="flex justify-between">
                <span class="text-[var(--text-secondary)]">Round Off</span>
                <span>{{ inv.roundOff | currency:'INR' }}</span>
              </div>
            }
          </div>

          <div class="border-t border-dashed border-[var(--border-primary)] my-4"></div>

          <div class="flex justify-between items-center mb-4">
            <span class="text-lg font-bold text-[var(--text-primary)]">Grand Total</span>
            <span class="text-xl font-bold text-[var(--accent-primary)]">{{ inv.grandTotal | currency:'INR' }}</span>
          </div>

          <div class="bg-[var(--bg-primary)] p-3 rounded border border-[var(--border-secondary)] space-y-2">
            <div class="flex justify-between text-sm">
              <span class="text-green-600 font-medium">Paid Amount</span>
              <span class="text-green-600 font-bold">- {{ inv.paidAmount | currency:'INR' }}</span>
            </div>
            <div class="flex justify-between text-sm items-center">
              <span class="font-bold" [ngClass]="inv.balanceAmount > 0 ? 'text-red-500' : 'text-[var(--text-secondary)]'">
                Balance Due
              </span>
              <span class="font-bold text-lg" [ngClass]="inv.balanceAmount > 0 ? 'text-red-500' : 'text-[var(--text-secondary)]'">
                {{ inv.balanceAmount | currency:'INR' }}
              </span>
            </div>
          </div>
        </div>

        <!-- Notes Card -->
        @if(inv.notes) {
          <div class="bg-[var(--bg-ternary)] p-4 rounded-lg border border-[var(--border-secondary)]">
            <h4 class="text-xs font-bold uppercase text-[var(--text-secondary)] mb-2">Notes</h4>
            <p class="text-sm text-[var(--text-primary)] italic whitespace-pre-wrap">{{ inv.notes }}</p>
          </div>
        }

      </div>

    </main>

  }
</div>

<!-- === PAYMENT DIALOG === -->
<p-dialog header="Record Payment" [(visible)]="showPaymentModal" [modal]="true" [style]="{width: '400px'}" [draggable]="false" [resizable]="false">
  <form [formGroup]="paymentForm" class="flex flex-col gap-4 mt-2">
    
    <div class="flex flex-col gap-2">
      <label class="text-sm font-bold">Amount Received <span class="text-red-500">*</span></label>
      <p-inputNumber formControlName="amount" mode="currency" currency="INR" locale="en-IN" styleClass="w-full"></p-inputNumber>
    </div>

    <div class="flex flex-col gap-2">
      <label class="text-sm font-bold">Payment Mode <span class="text-red-500">*</span></label>
      <p-select formControlName="paymentMethod" [options]="paymentMethods" optionLabel="label" optionValue="value" styleClass="w-full" appendTo="body"></p-select>
    </div>

    <div class="flex flex-col gap-2">
      <label class="text-sm font-bold">Reference / Transaction ID</label>
      <input pInputText formControlName="referenceNumber" class="w-full" placeholder="Optional" />
    </div>

    <div class="flex flex-col gap-2">
      <label class="text-sm font-bold">Notes</label>
      <textarea pInputTextarea formControlName="notes" rows="2" class="w-full"></textarea>
    </div>

  </form>
  <ng-template pTemplate="footer">
    <button pButton label="Cancel" class="p-button-text p-button-secondary" (click)="showPaymentModal.set(false)"></button>
    <button pButton label="Confirm Payment" class="p-button-primary" (click)="submitPayment()" [loading]="isProcessing()"></button>
  </ng-template>
</p-dialog>

<!-- === CANCEL DIALOG === -->
<p-dialog header="Cancel Invoice" [(visible)]="showCancelModal" [modal]="true" [style]="{width: '450px'}" [draggable]="false" [resizable]="false">
  <form [formGroup]="cancelForm" class="flex flex-col gap-4 mt-2">
    
    <div class="p-3 bg-red-50 border border-red-200 rounded text-red-700 text-sm flex items-center gap-3">
      <i class="pi pi-exclamation-triangle text-xl"></i>
      <div>
        <strong>Warning:</strong> This will reverse all financial entries and mark the invoice as cancelled.
      </div>
    </div>

    <div class="flex flex-col gap-2">
      <label class="text-sm font-bold">Cancellation Reason <span class="text-red-500">*</span></label>
      <textarea pInputTextarea formControlName="reason" rows="3" class="w-full" placeholder="Why is this invoice being cancelled?"></textarea>
      <small class="text-red-500" *ngIf="cancelForm.get('reason')?.dirty && cancelForm.get('reason')?.invalid">Reason is required (min 5 chars).</small>
    </div>

    <div class="flex items-center gap-2 mt-2">
      <p-checkbox formControlName="restock" [binary]="true" inputId="restockCheck"></p-checkbox>
      <label for="restockCheck" class="cursor-pointer text-sm">Return items to inventory stock?</label>
    </div>

  </form>
  <ng-template pTemplate="footer">
    <button pButton label="Abort" class="p-button-text" (click)="showCancelModal.set(false)"></button>
    <button pButton label="Confirm Cancellation" class="p-button-danger" (click)="submitCancel()" [disabled]="cancelForm.invalid" [loading]="isProcessing()"></button>
  </ng-template>
</p-dialog>

<!-- <p-toast></p-toast>
<p-confirmDialog></p-confirmDialog>

<div class="page-container animate-fadeIn">

  @if (isLoading()) {
    <div class="loading-state">
      <div class="skeleton-header">
        <div class="left-group">
          <p-skeleton shape="circle" size="3rem"></p-skeleton>
          <div class="text-group">
            <p-skeleton width="12rem" height="1.5rem"></p-skeleton>
            <p-skeleton width="8rem" height="1rem"></p-skeleton>
          </div>
        </div>
        <p-skeleton width="8rem" height="2.5rem"></p-skeleton>
      </div>
      <div class="skeleton-grid">
        <p-skeleton height="8rem" styleClass="w-full"></p-skeleton>
        <p-skeleton height="8rem" styleClass="w-full"></p-skeleton>
        <p-skeleton height="8rem" styleClass="w-full"></p-skeleton>
      </div>
      <p-skeleton height="20rem" styleClass="w-full"></p-skeleton>
    </div>
  } @else if (invoice(); as inv) {

    <header class="details-header">
      <div class="header-left">
        <button pButton icon="pi pi-arrow-left" class="p-button-text p-button-rounded back-btn" routerLink="/invoices"></button>
        
        <div class="title-group">
          <div class="title-row">
            <h1>Invoice #{{ inv.invoiceNumber }}</h1>
            <p-tag [value]="inv.status" [severity]="common.mapStatusToSeverity(inv.status)"></p-tag>
          </div>
          <div class="meta-row">
            <span class="label">Issued:</span>
            <span class="value">{{ common.formatDate(inv.invoiceDate) }}</span>
          </div>
        </div>
      </div>

      <div class="header-actions">
        @if (existingEmiId()) {
          <p-button label="View EMI Plan" icon="pi pi-percentage" styleClass="p-button-outlined p-button-help btn-sm"
            [routerLink]="['/emis', existingEmiId()]"></p-button>
        } @else {
          <p-button label="Create EMI" icon="pi pi-calculator" styleClass="p-button-outlined p-button-secondary btn-sm"
            (onClick)="onCreateEmi()"></p-button>
        }

        <p-button icon="pi pi-send" label="Email" styleClass="p-button-text btn-sm" 
          [loading]="isProcessing()" (onClick)="onEmail()"></p-button>
        
        <p-button icon="pi pi-download" label="PDF" styleClass="p-button-outlined btn-sm" 
          [loading]="isProcessing()" (onClick)="onDownload()"></p-button>
        
        <p-button icon="pi pi-pencil" styleClass="p-button-outlined p-button-secondary btn-sm icon-only" 
          [routerLink]="['/invoices', inv._id, 'edit']" pTooltip="Edit"></p-button>
        
        <p-button icon="pi pi-trash" styleClass="p-button-outlined p-button-danger btn-sm icon-only" 
          (onClick)="onDelete()" pTooltip="Delete"></p-button>
      </div>
    </header>

    <main class="invoice-body">
      
      <section class="info-grid">
        
        <div class="info-card">
          <div class="card-header">
            <i class="pi pi-user"></i>
            <h3>Billed To</h3>
          </div>
          <div class="card-content">
            <span class="customer-name">{{ inv.customerId?.name || 'Unknown Customer' }}</span>
            <div class="contact-details">
              <span>{{ inv.customerId?.email }}</span>
              <span>{{ inv.customerId?.phone }}</span>
            </div>
            <p class="address">{{ inv.billingAddress || 'No billing address provided.' }}</p>
          </div>
        </div>

        <div class="info-card">
          <div class="card-header">
            <i class="pi pi-truck"></i>
            <h3>Shipped To</h3>
          </div>
          <div class="card-content">
            <span class="customer-name">{{ inv.customerId?.name }}</span>
            <p class="address">{{ inv.shippingAddress || inv.billingAddress || 'Same as billing address.' }}</p>
          </div>
        </div>

        <div class="info-card">
          <div class="card-header">
            <i class="pi pi-info-circle"></i>
            <h3>Payment Details</h3>
          </div>
          <div class="meta-list">
            <div class="meta-item">
              <label>Due Date</label>
              <span>{{ common.formatDate(inv.dueDate) }}</span>
            </div>
            <div class="meta-item">
              <label>Payment Status</label>
              <p-tag [value]="inv.paymentStatus" [severity]="common.mapStatusToSeverity(inv.paymentStatus)"></p-tag>
            </div>
            <div class="meta-item highlight">
              <label>Amount Paid</label>
              <span class="success-text">{{ common.formatCurrency(inv.paidAmount) }}</span>
            </div>
          </div>
        </div>
      </section>

      <section class="items-container">
        <p-table [value]="inv.items || []" styleClass="compact-table" responsiveLayout="scroll">
          <ng-template pTemplate="header">
            <tr>
              <th style="width: 40%">Item Description</th>
              <th class="text-right">Qty</th>
              <th class="text-right">Price</th>
              <th class="text-right">Disc.</th>
              <th class="text-right">Tax</th>
              <th class="text-right">Total</th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-item>
            <tr>
              <td>
                <div class="item-name">{{ item.name }}</div>
                @if(item.hsnCode) { <span class="item-hsn">HSN: {{ item.hsnCode }}</span> }
              </td>
              <td class="text-right">
                {{ item.quantity }} <span class="unit">{{ item.unit }}</span>
              </td>
              <td class="text-right">{{ common.formatCurrency(item.price) }}</td>
              <td class="text-right discount-text">-{{ common.formatCurrency(item.discount) }}</td>
              <td class="text-right text-muted">{{ item.taxRate }}%</td>
              <td class="text-right font-medium">{{ common.formatCurrency(item.totalAmount) }}</td>
            </tr>
          </ng-template>
        </p-table>
      </section>

      <section class="footer-summary">
        
        <div class="notes-panel">
          <label class="section-label">Notes & Terms</label>
          <div class="notes-content">
            {{ inv.notes || 'No additional notes provided.' }}
          </div>

          @if(inv.attachedFiles?.length > 0) {
            <div class="attachments-area">
              <label class="section-label">Attachments</label>
              <div class="file-list">
                <div *ngFor="let file of inv.attachedFiles" class="file-chip">
                  <i class="pi pi-file"></i>
                  <span>Attachment</span>
                </div>
              </div>
            </div>
          }
        </div>

        <div class="totals-panel">
          <div class="calc-row">
            <label>Subtotal</label>
            <span>{{ common.formatCurrency(inv.subTotal) }}</span>
          </div>
          <div class="calc-row">
            <label>Discount</label>
            <span class="discount-text">- {{ common.formatCurrency(inv.totalDiscount) }}</span>
          </div>
          <div class="calc-row">
            <label>Tax</label>
            <span>+ {{ common.formatCurrency(inv.totalTax) }}</span>
          </div>
          @if (inv.roundOff) {
            <div class="calc-row">
              <label>Round Off</label>
              <span>{{ common.formatCurrency(inv.roundOff) }}</span>
            </div>
          }
          
          <div class="divider"></div>
          
          <div class="calc-row grand-total">
            <label>Grand Total</label>
            <span>{{ common.formatCurrency(inv.grandTotal) }}</span>
          </div>

          <div class="balance-badge">
            <label>Balance Due</label>
            <span>{{ common.formatCurrency(inv.balanceAmount) }}</span>
          </div>
        </div>
      </section>

    </main>
  }
</div> -->