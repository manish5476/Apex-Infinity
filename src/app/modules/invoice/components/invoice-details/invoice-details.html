<p-toast></p-toast>
<p-confirmDialog></p-confirmDialog>

<div class="invoice-page-container">

  @if (invoice(); as inv) {
  <div class="themed-card invoice-details-card animate-fadeIn">

    <div class="details-header">
      <div class="flex flex-col gap-2">
        <div class="flex items-center gap-4">
          <p-button icon="pi pi-arrow-left" styleClass="p-button-text p-button-rounded"
            routerLink="/invoices"></p-button>
          <h2 class="form-title m-0">Invoice {{ inv.invoiceNumber }}</h2>
        </div>
        <div class="flex items-center gap-2 pl-14">
          <p-tag [value]="inv.status | titlecase" [severity]="common.mapStatusToSeverity(inv.status ?? '')">
          </p-tag>

          <p-tag [value]="inv.paymentStatus | titlecase"
            [severity]="common.mapStatusToSeverity(inv.paymentStatus || '')">
          </p-tag>
        </div>
      </div>

      <div class="header-actions">
        
        <!-- ðŸ”¥ UPDATED: Conditional EMI Button -->
        @if (existingEmiId()) {
          <p-button label="View EMI Plan" icon="pi pi-percentage" styleClass="p-button-outlined p-button-help"
            [routerLink]="['/emis', existingEmiId()]" pTooltip="View active EMI Plan details">
          </p-button>
        } @else {
          <p-button label="Create EMI" icon="pi pi-calculator" styleClass="p-button-outlined p-button-secondary"
            (onClick)="onCreateEmi()" pTooltip="Create EMI Plan for this invoice">
          </p-button>
        }

        <p-button label="Email" icon="pi pi-send" styleClass="p-button-text" [loading]="isProcessing()"
          (onClick)="onEmail()" pTooltip="Email PDF to customer">
        </p-button>
        <p-button label="Download" icon="pi pi-download" styleClass="p-button-text" [loading]="isProcessing()"
          (onClick)="onDownload()" pTooltip="Download as PDF">
        </p-button>
        <p-button label="Edit" icon="pi pi-pencil" styleClass="p-button-outlined"
          [routerLink]="['/invoices', inv._id, 'edit']">
        </p-button>
        <p-button icon="pi pi-trash" styleClass="p-button-danger p-button-outlined" (onClick)="onDelete()"
          pTooltip="Delete Invoice">
        </p-button>
      </div>
    </div>
    
    <p-divider></p-divider>

    <div class="invoice-body">

      <section class="billing-info-grid">
        <div class="info-card">
          <label>Billed To</label>
          <span class="font-bold text-lg">{{ inv.customer?.name || 'N/A' }}</span>
          <span>{{ inv.customer?.email || '' }}</span>
          <span>{{ inv.customer?.phone || '' }}</span>
          <p class="address-text">{{ inv.billingAddress || 'No billing address on file.' }}</p>
        </div>

        <div class="info-card">
          <label>Ship To</label>
          <p class="address-text">{{ inv.shippingAddress || 'No shipping address on file.' }}</p>
        </div>

        <div class="info-card-grid">
          <div class="detail-field">
            <label>Invoice Number</label>
            <span>{{ inv.invoiceNumber }}</span>
          </div>
          <div class="detail-field">
            <label>Invoice Date</label>
            <span>{{ common.formatDate(inv.invoiceDate,'dd MMM yyyy') }}</span>
          </div>
          <div class="detail-field">
            <label>Due Date</label>
            <span>{{ common.formatDate(inv.dueDate,'dd MMM yyyy') }}</span>
          </div>
          <div class="detail-field">
            <label>Paid Amount</label>
            <span>{{ common.formatCurrency(inv.paidAmount) }}</span>
          </div>
        </div>
      </section>

      <section class="detail-section">
        <h4 class="section-title">Invoice Items</h4>
        <p-table [value]="inv.items || []" styleClass="p-table-striped">
          <ng-template pTemplate="header">
            <tr>
              <th>Item</th>
              <th class="text-right">Qty</th>
              <th class="text-right">Price</th>
              <th class="text-right">Discount</th>
              <th class="text-right">Tax</th>
              <th class="text-right">Total</th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-item>
            <tr>
              <td>
                <div class="font-bold">{{ item.name }}</div>
                @if (item.hsnCode) {
                <div class="text-xs text-[var(--text-label)]">
                  HSN: {{ item.hsnCode }}
                </div>
                }
              </td>
              <td class="text-right">{{ item.quantity }} {{ item.unit }}</td>
              <td class="text-right">{{ common.formatCurrency(item.price) }}</td>
              <td class="text-right">{{ common.formatCurrency(item.discount) }}</td>
              <td class="text-right">{{ item.taxRate }}%</td>
              <td class="text-right font-bold">
                {{ common.formatCurrency(item.totalAmount) }}
              </td>
            </tr>
          </ng-template>
        </p-table>
      </section>

      <section class="totals-notes-grid">
        <div class="notes-card">
          <label>Notes</label>
          <p>{{ inv.notes || 'No notes provided.' }}</p>
        </div>

        <div class="totals-card">
          <div class="total-row">
            <label>Subtotal</label>
            <span>{{ common.formatCurrency(inv.subTotal) }}</span>
          </div>
          <div class="total-row">
            <label>Total Discount</label>
            <span>- {{ common.formatCurrency(inv.totalDiscount) }}</span>
          </div>
          <div class="total-row">
            <label>Total Tax</label>
            <span>+ {{ common.formatCurrency(inv.totalTax) }}</span>
          </div>
          @if (inv.roundOff) {
          <div class="total-row">
            <label>Round Off</label>
            <span>{{ common.formatCurrency(inv.roundOff) }}</span>
          </div>
          }
          <p-divider></p-divider>
          <div class="total-row grand-total">
            <label>Grand Total</label>
            <span>{{ common.formatCurrency(inv.grandTotal) }}</span>
          </div>
          <div class="total-row">
            <label>Amount Paid</label>
            <span>- {{ common.formatCurrency(inv.paidAmount) }}</span>
          </div>
          <div class="total-row balance-due">
            <label>Balance Due</label>
            <span>{{ common.formatCurrency(inv.balanceAmount) }}</span>
          </div>
        </div>
      </section>

    </div>
  </div>
  } @else {
  <div class="themed-card invoice-details-card">
    <div class="details-header">
      <div class="header-left">
        <p-button icon="pi pi-arrow-left" styleClass="p-button-text p-button-rounded" routerLink="/invoices">
        </p-button>
        <h2 class="form-title">Loading...</h2>
      </div>
    </div>
    <p-divider></p-divider>
    <div class="details-body">
      <p>Loading invoice details or invoice not found.</p>
    </div>
  </div>
  }
</div>

<!-- <p-toast></p-toast>
<p-confirmDialog></p-confirmDialog>

<div class="invoice-page-container">

  @if (invoice(); as inv) {
  <div class="themed-card invoice-details-card animate-fadeIn">

    <div class="details-header">
      <div class="flex flex-col gap-2">
        <div class="flex items-center gap-4">
          <p-button icon="pi pi-arrow-left" styleClass="p-button-text p-button-rounded"
            routerLink="/invoices"></p-button>
          <h2 class="form-title m-0">Invoice {{ inv.invoiceNumber }}</h2>
        </div>
        <div class="flex items-center gap-2 pl-14">
          <p-tag [value]="inv.status | titlecase" [severity]="common.mapStatusToSeverity(inv.status ?? '')">
          </p-tag>

          <p-tag [value]="inv.paymentStatus | titlecase"
            [severity]="common.mapStatusToSeverity(inv.paymentStatus || '')">
          </p-tag>
        </div>
      </div>

      <div class="header-actions">
        <p-button label="Create EMI" icon="pi pi-calculator" styleClass="p-button-outlined p-button-secondary"
          (onClick)="onCreateEmi()" pTooltip="Create EMI Plan for this invoice">
        </p-button>

        <p-button label="Email" icon="pi pi-send" styleClass="p-button-text" [loading]="isProcessing()"
          (onClick)="onEmail()" pTooltip="Email PDF to customer">
        </p-button>
        <p-button label="Download" icon="pi pi-download" styleClass="p-button-text" [loading]="isProcessing()"
          (onClick)="onDownload()" pTooltip="Download as PDF">
        </p-button>
        <p-button label="Edit" icon="pi pi-pencil" styleClass="p-button-outlined"
          [routerLink]="['/invoices', inv._id, 'edit']">
        </p-button>
        <p-button icon="pi pi-trash" styleClass="p-button-danger p-button-outlined" (onClick)="onDelete()"
          pTooltip="Delete Invoice">
        </p-button>
      </div>
  </div>
  <p-divider></p-divider>

  <div class="invoice-body">

    <section class="billing-info-grid">
      <div class="info-card">
        <label>Billed To</label>
        <span class="font-bold text-lg">{{ inv.customer?.name || 'N/A' }}</span>
        <span>{{ inv.customer?.email || '' }}</span>
        <span>{{ inv.customer?.phone || '' }}</span>
        <p class="address-text">{{ inv.billingAddress || 'No billing address on file.' }}</p>
      </div>

      <div class="info-card">
        <label>Ship To</label>
        <p class="address-text">{{ inv.shippingAddress || 'No shipping address on file.' }}</p>
      </div>

      <div class="info-card-grid">
        <div class="detail-field">
          <label>Invoice Number</label>
          <span>{{ inv.invoiceNumber }}</span>
        </div>
        <div class="detail-field">
          <label>Invoice Date</label>
          <span>{{ common.formatDate(inv.invoiceDate,'dd MMM yyyy') }}</span>
        </div>
        <div class="detail-field">
          <label>Due Date</label>
          <span>{{ common.formatDate(inv.dueDate,'dd MMM yyyy') }}</span>
        </div>
        <div class="detail-field">
          <label>Paid Amount</label>
          <span>{{ common.formatCurrency(inv.paidAmount) }}</span>
        </div>
      </div>
    </section>

    <section class="detail-section">
      <h4 class="section-title">Invoice Items</h4>
      <p-table [value]="inv.items || []" styleClass="p-table-striped">
        <ng-template pTemplate="header">
          <tr>
            <th>Item</th>
            <th class="text-right">Qty</th>
            <th class="text-right">Price</th>
            <th class="text-right">Discount</th>
            <th class="text-right">Tax</th>
            <th class="text-right">Total</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-item>
          <tr>
            <td>
              <div class="font-bold">{{ item.name }}</div>
              @if (item.hsnCode) {
              <div class="text-xs text-[var(--text-label)]">
                HSN: {{ item.hsnCode }}
              </div>
              }
            </td>
            <td class="text-right">{{ item.quantity }} {{ item.unit }}</td>
            <td class="text-right">{{ common.formatCurrency(item.price) }}</td>
            <td class="text-right">{{ common.formatCurrency(item.discount) }}</td>
            <td class="text-right">{{ item.taxRate }}%</td>
            <td class="text-right font-bold">
              {{ common.formatCurrency(item.totalAmount) }}
            </td>
          </tr>
        </ng-template>
      </p-table>
    </section>

    <section class="totals-notes-grid">
      <div class="notes-card">
        <label>Notes</label>
        <p>{{ inv.notes || 'No notes provided.' }}</p>
      </div>

      <div class="totals-card">
        <div class="total-row">
          <label>Subtotal</label>
          <span>{{ common.formatCurrency(inv.subTotal) }}</span>
        </div>
        <div class="total-row">
          <label>Total Discount</label>
          <span>- {{ common.formatCurrency(inv.totalDiscount) }}</span>
        </div>
        <div class="total-row">
          <label>Total Tax</label>
          <span>+ {{ common.formatCurrency(inv.totalTax) }}</span>
        </div>
        @if (inv.roundOff) {
        <div class="total-row">
          <label>Round Off</label>
          <span>{{ common.formatCurrency(inv.roundOff) }}</span>
        </div>
        }
        <p-divider></p-divider>
        <div class="total-row grand-total">
          <label>Grand Total</label>
          <span>{{ common.formatCurrency(inv.grandTotal) }}</span>
        </div>
        <div class="total-row">
          <label>Amount Paid</label>
          <span>- {{ common.formatCurrency(inv.paidAmount) }}</span>
        </div>
        <div class="total-row balance-due">
          <label>Balance Due</label>
          <span>{{ common.formatCurrency(inv.balanceAmount) }}</span>
        </div>
      </div>
    </section>

  </div>
</div>
} @else {
<div class="themed-card invoice-details-card">
  <div class="details-header">
    <div class="header-left">
      <p-button icon="pi pi-arrow-left" styleClass="p-button-text p-button-rounded" routerLink="/invoices">
      </p-button>
      <h2 class="form-title">Loading...</h2>
    </div>
  </div>
  <p-divider></p-divider>
  <div class="details-body">
    <p>Loading invoice details or invoice not found.</p>
  </div>
</div>
}
</div> -->