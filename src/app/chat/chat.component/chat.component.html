<div class="chat-layout theme-glass">

  <aside class="sidebar">
    <div class="sidebar-header">
      <div class="org-info">
        <h3 class="org-name">Organization</h3>
        <span class="status-badge" [class.connected]="(chatService.connectionStatus$ | async) === 'connected'">
          {{ (chatService.connectionStatus$ | async) }}
        </span>
      </div>
      <button class="btn-icon-soft" (click)="openCreateModal()" title="Create channel">
        <span class="icon">Ôºã</span>
      </button>
    </div>
    <div class="sidebar-content">
      <div class="section-header">CHANNELS</div>
      <div class="channel-list">
        <div *ngFor="let ch of channels" class="channel-item" [class.active]="ch._id === activeChannelId"
          (click)="selectChannel(ch)">
          <div class="channel-info">
            <span class="hash">#</span>
            <span class="name">{{ ch.name || 'Unnamed' }}</span>
          </div>
          <span class="lock-icon" *ngIf="ch.type === 'private'">üîí</span>
        </div>
        <div *ngIf="channels.length === 0" class="empty-channels">
          No channels found
        </div>
      </div>
    </div>
  </aside>
  <main class="chat-main">
    <header class="chat-header" *ngIf="activeChannelId">
      <div class="header-info">
        <h4 class="channel-title">
          <span class="hash">#</span> {{ getChannelName(activeChannelId) }}
        </h4>
        <small class="member-count">
          {{ (channelUsers[activeChannelId]?.length || 0) }} members online
        </small>
      </div>
    </header>
    <div class="messages-container" #scrollContainer>
      <div *ngIf="!activeChannelId" class="placeholder-state">
        <div class="placeholder-content">
          <div class="icon-large">üëã</div>
          <h3>Welcome Back</h3>
          <p>Select a channel from the sidebar to start chatting.</p>
        </div>
      </div>

      <div *ngIf="activeChannelId && messages.length === 0" class="placeholder-state">
        <div class="placeholder-content">
          <p>No messages yet. Be the first to say hello in <strong>#{{ getChannelName(activeChannelId) }}</strong>!</p>
        </div>
      </div>

      <div *ngFor="let msg of messages" class="message-group" [class.mine]="getSenderId(msg) === currentUserId">

        <div class="avatar" *ngIf="getSenderId(msg) !== currentUserId">
          {{ getSenderName(msg).slice(0,2) | uppercase }}
        </div>

        <div class="message-content">
          <div class="message-meta" *ngIf="!msg.deleted && getSenderId(msg) !== currentUserId">
            <span class="sender-name">{{ getSenderName(msg) }}</span>
            <span class="timestamp">{{ msg.createdAt | date:'shortTime' }}</span>
          </div>

          <div class="bubble" [class.deleted]="msg.deleted">

            <div *ngIf="!msg.deleted">
              <div *ngIf="msg.body" class="text-content">{{ msg.body }}</div>

              <div *ngIf="msg.attachments?.length" class="attachments-grid">
                <div *ngFor="let f of msg.attachments" class="attach-item">
                  <a *ngIf="isImage(f.url)" [href]="f.url" target="_blank" class="img-preview-link">
                    <img [src]="f.url" alt="attachment" loading="lazy" />
                  </a>
                  <a *ngIf="!isImage(f.url)" [href]="f.url" target="_blank" class="file-card">
                    <span class="file-icon">üìÑ</span>
                    <span class="file-name">{{ f.name }}</span>
                  </a>
                </div>
              </div>
            </div>

            <div *ngIf="msg.deleted" class="deleted-notice">
              <span>üö´ Message deleted</span>
            </div>

            <button *ngIf="getSenderId(msg) === currentUserId && !msg.deleted" class="btn-delete"
              (click)="deleteMessage(msg)" title="Delete Message">üóë</button>
          </div>

          <div class="message-meta mine" *ngIf="!msg.deleted && getSenderId(msg) === currentUserId">
            {{ msg.createdAt | date:'shortTime' }}
          </div>
        </div>
      </div>
    </div>

    <div class="typing-pill" *ngIf="typingUser">
      <span class="dots">‚Ä¢‚Ä¢‚Ä¢</span> {{ typingUser }} is typing
    </div>

    <footer class="composer-area">
      <div class="composer-glass">
        <input #fileInput type="file" (change)="handleFileUpload($event)" hidden />

        <button class="btn-attach" (click)="triggerFilePicker()" [disabled]="isUploading">
          {{ isUploading ? '‚è≥' : 'üìé' }}
        </button>

        <input class="input-message" type="text" [(ngModel)]="messageInput" (input)="onTypingInput()"
          (keyup.enter)="sendMessage()" [disabled]="!activeChannelId"
          placeholder="Message #{{ getChannelName(activeChannelId) }}..." />

        <button class="btn-send" (click)="sendMessage()" [disabled]="!messageInput.trim() && !isUploading">
          ‚û§
        </button>
      </div>
    </footer>
  </main>

  <div class="modal-backdrop" *ngIf="showCreateModal">
    <div class="glass-modal">
      <div class="modal-header">
        <h3>Create Channel</h3>
        <button class="btn-close" (click)="closeCreateModal()">‚úï</button>
      </div>

      <div class="modal-body">
        <div class="form-group">
          <label>Channel Name</label>
          <div class="input-wrapper">
            <span class="prefix">#</span>
            <input type="text" [(ngModel)]="newChannelName" placeholder="announcements" />
          </div>
        </div>

        <div class="form-group checkbox">
          <label class="switch-label">
            <input type="checkbox" [(ngModel)]="isPrivateChannel" />
            <span class="label-text">Private Channel</span>
          </label>
        </div>

        <div *ngIf="isPrivateChannel" class="members-select-area">
          <small class="label-sm">Select Members</small>
          <div class="members-scroller">
            <label *ngFor="let u of masterUsers" class="member-row">
              <input type="checkbox" [checked]="selectedMembers.has(u._id)" (change)="toggleMemberSelection(u._id)" />
              <span class="name">{{ u.name }}</span>
            </label>
            <div *ngIf="masterUsers.length === 0" class="text-muted">No other users found</div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-ghost" (click)="closeCreateModal()">Cancel</button>
        <button class="btn-primary" (click)="submitCreateChannel()" [disabled]="!newChannelName.trim()">Create
          Channel</button>
      </div>
    </div>
  </div>
</div>

<!-- <div class="chat-layout">
  <aside class="sidebar">
    <div class="sidebar-header">
      <h3>Organization</h3>
      <button class="add-channel-btn" (click)="openCreateModal()" title="Create New Channel"
        aria-label="Create Channel">
        +
      </button>
    </div>

    <div class="channel-list">
      <div class="section-label">Channels</div>

      @for (channel of channels$ | async; track channel._id) {
      <div (click)="selectChannel(channel)" [class.active]="channel._id === activeChannelId" class="channel-item">
        <span class="hash">#</span>
        <span class="name">{{ channel.name || 'Unnamed' }}</span>
      </div>
      }

      @if ((channels$ | async)?.length === 0) {
      <div class="section-label" style="text-transform: none; opacity: 0.5;">
        No channels found
      </div>
      }
    </div>
  </aside>

  <main class="chat-area">

    @if (activeChannelId) {
    <header class="chat-header">
      <div class="channel-info">
        <h4>{{ getChannelName(activeChannelId) }}</h4>
        <small>{{ (chatService.channelUsers$ | async)?.[activeChannelId]?.length || 0 }} members online</small>
      </div>
    </header>
    }

    <div class="messages-feed" #scrollContainer>

      @if (!(messages$ | async)?.length && activeChannelId) {
      <div class="empty-state">
        <p>No messages yet. Start the conversation in #{{ getChannelName(activeChannelId) }}!</p>
      </div>
      }

      @if (!activeChannelId) {
      <div class="empty-state">
        <p>Select a channel to start chatting</p>
      </div>
      }

      @for (msg of messages$ | async; track msg._id) {
      <div class="message-row" [class.mine]="getSenderId(msg) === currentUserdId">

        @if (getSenderId(msg) !== currentUserdId) {
        <div class="avatar">
          {{ getSenderName(msg).slice(0,2).toUpperCase() }}
        </div>
        }

        <div class="message-bubble" [class.is-deleted]="msg.deleted">

          @if (getSenderId(msg) !== currentUserdId && !msg.deleted) {
          <div class="msg-meta">
            <span class="sender-name">{{ getSenderName(msg) }}</span>
          </div>
          }

          @if (!msg.deleted) {
          @if (msg.body) {
          <div class="msg-body">{{ msg.body }}</div>
          }

          @if (msg.attachments?.length) {
          <div class="attachments-grid">
            @for (file of msg.attachments; track file.url) {
            <div class="attachment-item">
              @if (isImage(file.url)) {
              <a [appImageViewer]="file.url" target="_blank">
                <img [src]="file.url" alt="attachment" class="chat-image" />
              </a>
              } @else {
              <a [appImageViewer]="file.url" target="_blank" class="file-link">
                <span class="icon">üìÑ</span> {{ file.name }}
              </a>
             
              }
            </div>
            }
          </div>
          }
          } @else {
          <div class="msg-body deleted-text">
            <i>üö´ This message was deleted</i>
          </div>
          }

          <div class="msg-time">{{ msg.createdAt | date:'shortTime' }}</div>

          @if (getSenderId(msg) === currentUserdId && !msg.deleted) {
          <button class="delete-btn" (click)="deleteMessage(msg)" title="Delete">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="3 6 5 6 21 6"></polyline>
              <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
            </svg>
          </button>
          }

        </div>
      </div>
      }
    </div>

    @if (typingUsers$ | async; as typer) {
    <div class="typing-indicator">
      <small>{{ typer }} is typing...</small>
    </div>
    }

    <footer class="chat-input-area">
      <div class="input-wrapper">

        <input type="file" #fileInput (change)="handleFileUpload($event)" style="display: none" />

        <button class="attach-btn" (click)="fileInput.click()" title="Attach File" [disabled]="isUploading">
          @if (isUploading) {
          <span class="loader">‚è≥</span>
          } @else {
          üìé
          }
        </button>

        <input type="text" [(ngModel)]="messageInput" (keyup.enter)="sendMessage()" (input)="onTyping()"
          placeholder="Message #{{ getChannelName(activeChannelId) }}..." [disabled]="!activeChannelId" />

        <button class="send-btn" (click)="sendMessage()" [disabled]="!messageInput.trim() && !isUploading">
          Send
        </button>
      </div>
    </footer>

  </main>
</div>

@if (showCreateModal) {
<div class="modal-overlay" (click)="closeCreateModal()">
  <div class="modal-box" (click)="$event.stopPropagation()">

    <div class="modal-header">
      <h2>Create New Channel</h2>
      <button class="close-btn" (click)="closeCreateModal()" aria-label="Close">&times;</button>
    </div>

    <div class="modal-body">
      <div class="form-group">
        <label>Channel Name</label>
        <div class="input-prefix-group">
          <span class="prefix">#</span>
          <input type="text" [(ngModel)]="newChannelName" (keyup.enter)="submitCreateChannel()"
            placeholder="e.g. announcements" autofocus />
        </div>
      </div>

      <div class="checkbox-group">
        <input type="checkbox" id="privateCheck" [(ngModel)]="isPrivateChannel">
        <label for="privateCheck">
          <strong>Make Private</strong>
          <small>Only invited members (and you) can view this channel.</small>
        </label>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn-cancel" (click)="closeCreateModal()">Cancel</button>
      <button class="btn-create" (click)="submitCreateChannel()" [disabled]="!newChannelName.trim()">
        Create Channel
      </button>
    </div>

  </div>
</div>
} -->