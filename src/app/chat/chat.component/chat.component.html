
<div class="chat-layout theme-glass">

  <aside class="sidebar">
    <div class="sidebar-header">
      <div class="org-info">
        <h3 class="org-name">Organization</h3>
        <span class="status-badge" [class.connected]="(socketService.connectionStatus$ | async) === 'connected'">
          {{ (socketService.connectionStatus$ | async) }}
        </span>
      </div>
      <button class="btn-icon-soft" (click)="openCreateModal()" title="Create channel">
        <span class="icon">Ôºã</span>
      </button>
    </div>

    <div class="sidebar-content">
      <div class="section-header">CHANNELS</div>
      <div class="channel-list">
        
        @for (ch of channels; track ch._id) {
          <div class="channel-item" 
               [class.active]="ch._id === activeChannelId"
               (click)="selectChannel(ch)">
            <div class="channel-info">
              <span class="hash">#</span>
              <span class="name">{{ ch.name || 'Unnamed' }}</span>
            </div>
            @if (ch.type === 'private') {
              <span class="lock-icon">üîí</span>
            }
          </div>
        } @empty {
          <div class="empty-channels">No channels found</div>
        }

      </div>
    </div>
  </aside>

  <main class="chat-main">
    
    @if (activeChannelId) {
      <header class="chat-header">
        <div class="header-info">
          <h4 class="channel-title">
            <span class="hash">#</span> {{ getChannelName(activeChannelId) }}
          </h4>
          <small class="member-count">
            {{ (channelUsers[activeChannelId]?.length || 0) }} members online
          </small>
        </div>
      </header>

      <div class="messages-container" #scrollContainer>
        
        @if (messages.length === 0) {
          <div class="placeholder-state">
            <div class="placeholder-content">
              <p>No messages yet. Be the first to say hello in <strong>#{{ getChannelName(activeChannelId) }}</strong>!</p>
            </div>
          </div>
        }

        @for (msg of messages; track msg._id) {
          <div class="message-group" [class.mine]="getSenderId(msg) === currentUserId">
            
            @if (getSenderId(msg) !== currentUserId) {
              <div class="avatar">
                {{ getSenderName(msg).slice(0,2) | uppercase }}
              </div>
            }

            <div class="message-content">
              @if (!msg.deleted && getSenderId(msg) !== currentUserId) {
                <div class="message-meta">
                  <span class="sender-name">{{ getSenderName(msg) }}</span>
                  <span class="timestamp">{{ msg.createdAt | date:'shortTime' }}</span>
                </div>
              }

              <div class="bubble" [class.deleted]="msg.deleted">
                @if (!msg.deleted) {
                  <div>
                    @if (msg.body) {
                      <div class="text-content">{{ msg.body }}</div>
                    }

                    @if (msg.attachments?.length) {
                      <div class="attachments-grid">
                        @for (f of msg.attachments; track f.url) {
                          <div class="attach-item">
                            @if (isImage(f.url)) {
                              <a [href]="f.url" target="_blank" class="img-preview-link">
                                <img [src]="f.url" alt="attachment" loading="lazy" />
                              </a>
                            } @else {
                              <a [href]="f.url" target="_blank" class="file-card">
                                <span class="file-icon">üìÑ</span>
                                <span class="file-name">{{ f.name }}</span>
                              </a>
                            }
                          </div>
                        }
                      </div>
                    }
                  </div>
                } @else {
                  <div class="deleted-notice">
                    <span>üö´ Message deleted</span>
                  </div>
                }

                @if (getSenderId(msg) === currentUserId && !msg.deleted) {
                  <button class="btn-delete" (click)="deleteMessage(msg)" title="Delete Message">üóë</button>
                }
              </div>

              @if (!msg.deleted && getSenderId(msg) === currentUserId) {
                <div class="message-meta mine">
                  {{ msg.createdAt | date:'shortTime' }}
                </div>
              }
            </div>
          </div>
        }

      </div>

      @if (typingUser) {
        <div class="typing-pill">
          <span class="dots">‚Ä¢‚Ä¢‚Ä¢</span> {{ typingUser }} is typing
        </div>
      }

      <footer class="composer-area">
        <div class="composer-glass">
          <input #fileInput type="file" (change)="handleFileUpload($event)" hidden />

          <button class="btn-attach" (click)="triggerFilePicker()" [disabled]="isUploading">
            {{ isUploading ? '‚è≥' : 'üìé' }}
          </button>

          <input class="input-message" type="text" 
                 [(ngModel)]="messageInput" 
                 (input)="onTypingInput()"
                 (keyup.enter)="sendMessage()" 
                 [disabled]="!activeChannelId"
                 placeholder="Message #{{ getChannelName(activeChannelId) }}..." />

          <button class="btn-send" (click)="sendMessage()" [disabled]="!messageInput.trim() && !isUploading">
            ‚û§
          </button>
        </div>
      </footer>

    } @else {
      <div class="placeholder-state">
        <div class="placeholder-content">
          <div class="icon-large">üëã</div>
          <h3>Welcome Back</h3>
          <p>Select a channel from the sidebar to start chatting.</p>
        </div>
      </div>
    }

  </main>

  @if (showCreateModal) {
    <div class="modal-backdrop">
      <div class="glass-modal">
        <div class="modal-header">
          <h3>Create Channel</h3>
          <button class="btn-close" (click)="closeCreateModal()">‚úï</button>
        </div>

        <div class="modal-body">
          <div class="form-group">
            <label>Channel Name</label>
            <div class="input-wrapper">
              <span class="prefix">#</span>
              <input type="text" [(ngModel)]="newChannelName" placeholder="announcements" />
            </div>
          </div>

          <div class="form-group checkbox">
            <label class="switch-label">
              <input type="checkbox" [(ngModel)]="isPrivateChannel" />
              <span class="label-text">Private Channel</span>
            </label>
          </div>

          @if (isPrivateChannel) {
            <div class="members-select-area">
              <small class="label-sm">Select Members</small>
              <div class="members-scroller">
                @for (u of masterUsers; track u._id) {
                  <label class="member-row">
                    <input type="checkbox" [checked]="selectedMembers.has(u._id)" (change)="toggleMemberSelection(u._id)" />
                    <span class="name">{{ u.name }}</span>
                  </label>
                }
                @if (masterUsers.length === 0) {
                  <div class="text-muted">No other users found</div>
                }
              </div>
            </div>
          }
        </div>

        <div class="modal-footer">
          <button class="btn-ghost" (click)="closeCreateModal()">Cancel</button>
          <button class="btn-primary" (click)="submitCreateChannel()" [disabled]="!newChannelName.trim()">Create Channel</button>
        </div>
      </div>
    </div>
  }

</div>
