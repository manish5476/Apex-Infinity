<p-toast position="bottom-right"></p-toast>

<div class="chat-system theme-glass" [class.mobile-view]="mobileView()" [class.sidebar-open]="sidebarOpen()">

  <!-- Mobile Sidebar Toggle -->
  <div class="mobile-header-bar" *ngIf="mobileView()">
    <button class="sidebar-toggle-btn" (click)="toggleSidebar()">
      <i class="pi" [class.pi-bars]="!sidebarOpen()" [class.pi-times]="sidebarOpen()"></i>
    </button>
    
    <div class="mobile-channel-info" *ngIf="activeChannel()">
      <span class="hash">#</span>
      <span class="channel-name">{{ activeChannel()?.name }}</span>
      <span class="online-count">{{ activeChannelUsers().length }} online</span>
    </div>
  </div>

  <!-- Sidebar with Glass Effect -->
  <aside class="sidebar glass-sidebar" [class.open]="sidebarOpen()">
    <div class="sidebar-header glass-header">
      <div class="org-info">
        <div class="org-logo">
          <i class="pi pi-comments"></i>
        </div>
        <div class="org-details">
          <h3 class="org-name">Team Chat</h3>
          <div class="connection-status">
            <span class="status-dot" [class.connected]="(socketService.connectionStatus$ | async) === 'connected'"></span>
            <span class="status-text">{{ (socketService.connectionStatus$ | async) }}</span>
          </div>
        </div>
      </div>
      
      <button class="btn-create-channel glass-btn" (click)="openCreateModal()" title="Create channel">
        <i class="pi pi-plus"></i>
      </button>
    </div>

    <div class="sidebar-content custom-scrollbar">
      <!-- Channels Section -->
      <div class="section-header glass-section-header">
        <span class="section-title">CHANNELS</span>
        <span class="channel-count">{{ channels().length }}</span>
      </div>
      
      <div class="channel-list">
        @for (ch of channels(); track ch._id) {
          <div class="channel-item glass-channel" 
               [class.active]="ch._id === activeChannelId()"
               (click)="selectChannel(ch)">
            <div class="channel-info">
              <div class="channel-icon">
                <i class="pi" [class.pi-hashtag]="ch.type === 'public'" [class.pi-lock]="ch.type === 'private'"></i>
              </div>
              <div class="channel-details">
                <span class="channel-name">{{ ch.name || 'Unnamed' }}</span>
                <span class="channel-meta">
                  {{ channelUsers()[ch._id]?.length || 0 }} online
                </span>
              </div>
            </div>
            
            @if (unreadCounts()[ch._id] > 0) {
              <span class="unread-badge glass-badge">{{ unreadCounts()[ch._id] }}</span>
            }
          </div>
        } @empty {
          <div class="empty-channels glass-empty">
            <i class="pi pi-comment"></i>
            <p>No channels yet</p>
          </div>
        }
      </div>
      
      <!-- Online Users Section -->
      @if (activeChannelId() && activeChannelUsers().length > 0) {
        <div class="section-header glass-section-header">
          <span class="section-title">ONLINE</span>
          <span class="online-count">{{ activeChannelUsers().length }}</span>
        </div>
        
        <div class="user-list">
          @for (userId of activeChannelUsers(); track userId) {
            @if (userId !== currentUserId()) {
              <div class="user-item glass-user">
                <div class="user-avatar">
                  {{ getInitials(userId) }}
                </div>
                <span class="user-name">{{ getUserName(userId) }}</span>
                <span class="online-indicator"></span>
              </div>
            }
          }
        </div>
      }
    </div>
  </aside>

  <!-- Main Chat Area -->
  <main class="chat-main glass-main" [class.full-width]="!sidebarOpen() && mobileView()">
    
    @if (activeChannelId()) {
      <!-- Chat Header -->
      <header class="chat-header glass-header">
        <div class="header-left">
          @if (mobileView()) {
            <button class="back-to-channels" (click)="toggleSidebar()">
              <i class="pi pi-arrow-left"></i>
            </button>
          }
          
          <div class="channel-header-info">
            <div class="channel-title">
              <span class="hash">#</span>
              <h2>{{ activeChannel()?.name }}</h2>
              @if (activeChannel()?.type === 'private') {
                <i class="pi pi-lock private-icon"></i>
              }
            </div>
            <div class="channel-subtitle">
              <span class="member-count">{{ activeChannelUsers().length }} members online</span>
              <span class="message-count">{{ messages().length }} messages</span>
            </div>
          </div>
        </div>
        
        <div class="header-actions">
          <button class="btn-header-action" title="Search">
            <i class="pi pi-search"></i>
          </button>
          <button class="btn-header-action" title="Channel info">
            <i class="pi pi-info-circle"></i>
          </button>
        </div>
      </header>

      <!-- Messages Container -->
      <div class="messages-container custom-scrollbar" #scrollContainer>
        
        <!-- Empty State -->
        @if (messages().length === 0) {
          <div class="empty-state glass-empty-state">
            <div class="empty-icon">
              <i class="pi pi-comment"></i>
            </div>
            <h3>No messages yet</h3>
            <p>Start the conversation in <strong>#{{ activeChannel()?.name }}</strong></p>
            <p class="empty-hint">Send a message, share a file, or say hello!</p>
          </div>
        }

        <!-- Messages -->
        <div class="messages-timeline">
          @for (msg of messages(); track msg._id; let i = $index) {
            @if (showDateSeparator(i, msg)) {
              <div class="date-separator glass-separator">
                <span class="date-text">{{ msg.createdAt | date:'fullDate' }}</span>
              </div>
            }
            
            <div class="message-group" [class.mine]="getSenderId(msg) === currentUserId()">
              
              <!-- Avatar (for others) -->
              @if (getSenderId(msg) !== currentUserId()) {
                <div class="message-avatar glass-avatar" 
                     [attr.data-initials]="getSenderAvatar(msg)"
                     [title]="getSenderName(msg)">
                  {{ getSenderAvatar(msg) }}
                </div>
              }

              <div class="message-content">
                <!-- Message Meta -->
                @if (!msg.deleted && getSenderId(msg) !== currentUserId()) {
                  <div class="message-meta">
                    <span class="sender-name">{{ getSenderName(msg) }}</span>
                    <span class="timestamp">{{ msg.createdAt | date:'MMM d, h:mm a' }}</span>
                  </div>
                }

                <!-- Message Bubble -->
                <div class="message-bubble glass-bubble" 
                     [class.mine]="getSenderId(msg) === currentUserId()"
                     [class.deleted]="msg.deleted">
                  
                  @if (!msg.deleted) {
                    <!-- Message Text -->
                    @if (msg.body) {
                      <div class="message-text">{{ msg.body }}</div>
                    }

                    <!-- Attachments -->
                    @if (msg.attachments?.length) {
                      <div class="attachments-grid">
                        @for (f of msg.attachments; track f.url) {
                          <div class="attachment-item glass-attachment">
                            @if (isImage(f.url)) {
                              <div class="image-attachment">
                                <a [href]="f.url" target="_blank" class="image-preview">
                                  <img [src]="f.url" alt="Attachment" loading="lazy" />
                                  <div class="image-overlay">
                                    <i class="pi pi-external-link"></i>
                                  </div>
                                </a>
                                <span class="image-caption">{{ f.name }}</span>
                              </div>
                            } @else if (isVideo(f.url)) {
                              <div class="video-attachment">
                                <video controls>
                                  <source [src]="f.url" [type]="getVideoType(f.url)">
                                  Your browser does not support the video tag.
                                </video>
                                <span class="file-name">{{ f.name }}</span>
                              </div>
                            } @else if (isAudio(f.url)) {
                              <div class="audio-attachment">
                                <audio controls>
                                  <source [src]="f.url" [type]="getAudioType(f.url)">
                                  Your browser does not support the audio tag.
                                </audio>
                                <span class="file-name">{{ f.name }}</span>
                              </div>
                            } @else {
                              <a [href]="f.url" target="_blank" class="file-attachment glass-file">
                                <div class="file-icon">
                                  <i class="pi" [ngClass]="getFileIconClass(f.url)"></i>
                                </div>
                                <div class="file-info">
                                  <span class="file-name">{{ f.name }}</span>
                                  <span class="file-size">{{ formatFileSize(f.size) }}</span>
                                </div>
                                <div class="file-action">
                                  <i class="pi pi-download"></i>
                                </div>
                              </a>
                            }
                          </div>
                        }
                      </div>
                    }
                  } @else {
                    <!-- Deleted Message -->
                    <div class="deleted-message">
                      <i class="pi pi-trash"></i>
                      <span>Message deleted</span>
                    </div>
                  }

                  <!-- Message Actions -->
                  @if (getSenderId(msg) === currentUserId() && !msg.deleted) {
                    <div class="message-actions">
                      <button class="btn-message-action" title="Edit">
                        <i class="pi pi-pencil"></i>
                      </button>
                      <button class="btn-message-action danger" (click)="deleteMessage(msg)" title="Delete">
                        <i class="pi pi-trash"></i>
                      </button>
                    </div>
                  }
                </div>

                <!-- My Message Meta -->
                @if (!msg.deleted && getSenderId(msg) === currentUserId()) {
                  <div class="message-meta mine">
                    <span class="timestamp">{{ msg.createdAt | date:'h:mm a' }}</span>
                    <span class="status" [class.read]="msg?.read">
                      <i class="pi" [ngClass]="msg?.read ? 'pi-check-double' : 'pi-check'"></i>
                    </span>
                  </div>
                }
              </div>
            </div>
          }
        </div>
      </div>

      <!-- Typing Indicator -->
      @if (typingUser()) {
        <div class="typing-indicator glass-typing">
          <div class="typing-dots">
            <span></span><span></span><span></span>
          </div>
          <span class="typing-text">{{ typingUser() }} is typing...</span>
        </div>
      }

      <!-- Message Composer -->
      <footer class="composer-area glass-composer">
        <div class="composer-toolbar">
          <button class="btn-composer-action" (click)="triggerFilePicker()" [disabled]="isUploading" title="Attach file">
            <i class="pi" [ngClass]="isUploading ? 'pi-spinner pi-spin' : 'pi-paperclip'"></i>
          </button>
          
          <button class="btn-composer-action" title="Emoji">
            <i class="pi pi-smile"></i>
          </button>
          
          <button class="btn-composer-action" title="Format">
            <i class="pi pi-code"></i>
          </button>
        </div>
        
        <div class="composer-input-wrapper glass-input">
          <input #fileInput type="file" (change)="handleFileUpload($event)" hidden multiple />
          
          <textarea class="message-input custom-scrollbar"
                    [(ngModel)]="messageInput"
                    (input)="onTypingInput()"
                    (keydown.enter)="sendOnEnter($event)"
                    [placeholder]="'Message #' + (activeChannel()?.name || 'channel') + '...'"
                    rows="1"></textarea>
          
          <div class="input-actions">
            @if (messageInput.trim()) {
              <button class="btn-clear-input" (click)="messageInput = ''" title="Clear">
                <i class="pi pi-times"></i>
              </button>
            }
          </div>
        </div>
        
        <button class="btn-send glass-btn-primary" 
                (click)="sendMessage()" 
                [disabled]="!messageInput.trim() && !isUploading"
                [title]="isUploading ? 'Uploading...' : 'Send message'">
          <i class="pi" [ngClass]="isUploading ? 'pi-spinner pi-spin' : 'pi-send'"></i>
        </button>
      </footer>
    } @else {
      <!-- No Channel Selected -->
      <div class="welcome-state glass-welcome">
        <div class="welcome-content">
          <div class="welcome-icon">
            <i class="pi pi-comments"></i>
          </div>
          <h2>Welcome to Team Chat</h2>
          <p>Select a channel from the sidebar to start chatting with your team</p>
          
          <div class="welcome-actions">
            <button class="btn-create-first-channel glass-btn-primary" (click)="openCreateModal()">
              <i class="pi pi-plus"></i> Create your first channel
            </button>
          </div>
        </div>
      </div>
    }
  </main>

  <!-- Create Channel Modal -->
  @if (showCreateModal) {
    <div class="modal-backdrop glass-backdrop">
      <div class="create-modal glass-modal">
        <div class="modal-header glass-modal-header">
          <h3>Create New Channel</h3>
          <button class="btn-close-modal" (click)="closeCreateModal()">
            <i class="pi pi-times"></i>
          </button>
        </div>
        
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">Channel Name</label>
            <div class="input-with-prefix glass-input">
              <span class="input-prefix">#</span>
              <input type="text" 
                     [(ngModel)]="newChannelName" 
                     placeholder="e.g., announcements, general"
                     maxlength="50"
                     autofocus />
            </div>
            <small class="hint">Use lowercase with hyphens for best results</small>
          </div>
          
          <div class="form-group">
            <label class="form-checkbox glass-checkbox">
              <input type="checkbox" [(ngModel)]="isPrivateChannel" />
              <span class="checkmark"></span>
              <span class="checkbox-label">
                <i class="pi pi-lock"></i>
                Private channel
                <small>Only selected members can join</small>
              </span>
            </label>
          </div>
          
          @if (isPrivateChannel) {
            <div class="form-group">
              <label class="form-label">Select Members</label>
              <div class="members-selector glass-scroll">
                @for (user of masterUsers; track user._id) {
                  @if (user._id !== currentUserId()) {
                    <label class="member-selector-item glass-selector">
                      <input type="checkbox" 
                             [checked]="selectedMembers.has(user._id)"
                             (change)="toggleMemberSelection(user._id)" />
                      <div class="member-avatar">{{ user.name?.charAt(0) }}</div>
                      <div class="member-info">
                        <span class="member-name">{{ user.name }}</span>
                        <span class="member-role">{{ user.role || 'Member' }}</span>
                      </div>
                    </label>
                  }
                }
                @if (masterUsers.length === 0) {
                  <div class="empty-members glass-empty">
                    <i class="pi pi-users"></i>
                    <p>No other users found</p>
                  </div>
                }
              </div>
            </div>
          }
        </div>
        
        <div class="modal-footer glass-modal-footer">
          <button class="btn-modal-cancel" (click)="closeCreateModal()">Cancel</button>
          <button class="btn-modal-create glass-btn-primary" 
                  (click)="submitCreateChannel()" 
                  [disabled]="!newChannelName.trim()">
            <i class="pi pi-plus"></i> Create Channel
          </button>
        </div>
      </div>
    </div>
  }
</div>

<!-- 
<div class="chat-layout theme-glass">

  <aside class="sidebar">
    <div class="sidebar-header">
      <div class="org-info">
        <h3 class="org-name">Organization</h3>
        <span class="status-badge" [class.connected]="(socketService.connectionStatus$ | async) === 'connected'">
          {{ (socketService.connectionStatus$ | async) }}
        </span>
      </div>
      <button class="btn-icon-soft" (click)="openCreateModal()" title="Create channel">
        <span class="icon">Ôºã</span>
      </button>
    </div>

    <div class="sidebar-content">
      <div class="section-header">CHANNELS</div>
      <div class="channel-list">
        
        @for (ch of channels; track ch._id) {
          <div class="channel-item" 
               [class.active]="ch._id === activeChannelId"
               (click)="selectChannel(ch)">
            <div class="channel-info">
              <span class="hash">#</span>
              <span class="name">{{ ch.name || 'Unnamed' }}</span>
            </div>
            @if (ch.type === 'private') {
              <span class="lock-icon">üîí</span>
            }
          </div>
        } @empty {
          <div class="empty-channels">No channels found</div>
        }

      </div>
    </div>
  </aside>

  <main class="chat-main">
    
    @if (activeChannelId) {
      <header class="chat-header">
        <div class="header-info">
          <h4 class="channel-title">
            <span class="hash">#</span> {{ getChannelName(activeChannelId) }}
          </h4>
          <small class="member-count">
            {{ (channelUsers[activeChannelId]?.length || 0) }} members online
          </small>
        </div>
      </header>

      <div class="messages-container" #scrollContainer>
        
        @if (messages.length === 0) {
          <div class="placeholder-state">
            <div class="placeholder-content">
              <p>No messages yet. Be the first to say hello in <strong>#{{ getChannelName(activeChannelId) }}</strong>!</p>
            </div>
          </div>
        }

        @for (msg of messages; track msg._id) {
          <div class="message-group" [class.mine]="getSenderId(msg) === currentUserId">
            
            @if (getSenderId(msg) !== currentUserId) {
              <div class="avatar">
                {{ getSenderName(msg).slice(0,2) | uppercase }}
              </div>
            }

            <div class="message-content">
              @if (!msg.deleted && getSenderId(msg) !== currentUserId) {
                <div class="message-meta">
                  <span class="sender-name">{{ getSenderName(msg) }}</span>
                  <span class="timestamp">{{ msg.createdAt | date:'shortTime' }}</span>
                </div>
              }

              <div class="bubble" [class.deleted]="msg.deleted">
                @if (!msg.deleted) {
                  <div>
                    @if (msg.body) {
                      <div class="text-content">{{ msg.body }}</div>
                    }

                    @if (msg.attachments?.length) {
                      <div class="attachments-grid">
                        @for (f of msg.attachments; track f.url) {
                          <div class="attach-item">
                            @if (isImage(f.url)) {
                              <a [href]="f.url" target="_blank" class="img-preview-link">
                                <img [src]="f.url" alt="attachment" loading="lazy" />
                              </a>
                            } @else {
                              <a [href]="f.url" target="_blank" class="file-card">
                                <span class="file-icon">üìÑ</span>
                                <span class="file-name">{{ f.name }}</span>
                              </a>
                            }
                          </div>
                        }
                      </div>
                    }
                  </div>
                } @else {
                  <div class="deleted-notice">
                    <span>üö´ Message deleted</span>
                  </div>
                }

                @if (getSenderId(msg) === currentUserId && !msg.deleted) {
                  <button class="btn-delete" (click)="deleteMessage(msg)" title="Delete Message">üóë</button>
                }
              </div>

              @if (!msg.deleted && getSenderId(msg) === currentUserId) {
                <div class="message-meta mine">
                  {{ msg.createdAt | date:'shortTime' }}
                </div>
              }
            </div>
          </div>
        }

      </div>

      @if (typingUser) {
        <div class="typing-pill">
          <span class="dots">‚Ä¢‚Ä¢‚Ä¢</span> {{ typingUser }} is typing
        </div>
      }

      <footer class="composer-area">
        <div class="composer-glass">
          <input #fileInput type="file" (change)="handleFileUpload($event)" hidden />

          <button class="btn-attach" (click)="triggerFilePicker()" [disabled]="isUploading">
            {{ isUploading ? '‚è≥' : 'üìé' }}
          </button>

          <input class="input-message" type="text" 
                 [(ngModel)]="messageInput" 
                 (input)="onTypingInput()"
                 (keyup.enter)="sendMessage()" 
                 [disabled]="!activeChannelId"
                 placeholder="Message #{{ getChannelName(activeChannelId) }}..." />

          <button class="btn-send" (click)="sendMessage()" [disabled]="!messageInput.trim() && !isUploading">
            ‚û§
          </button>
        </div>
      </footer>

    } @else {
      <div class="placeholder-state">
        <div class="placeholder-content">
          <div class="icon-large">üëã</div>
          <h3>Welcome Back</h3>
          <p>Select a channel from the sidebar to start chatting.</p>
        </div>
      </div>
    }

  </main>

  @if (showCreateModal) {
    <div class="modal-backdrop">
      <div class="glass-modal">
        <div class="modal-header">
          <h3>Create Channel</h3>
          <button class="btn-close" (click)="closeCreateModal()">‚úï</button>
        </div>

        <div class="modal-body">
          <div class="form-group">
            <label>Channel Name</label>
            <div class="input-wrapper">
              <span class="prefix">#</span>
              <input type="text" [(ngModel)]="newChannelName" placeholder="announcements" />
            </div>
          </div>

          <div class="form-group checkbox">
            <label class="switch-label">
              <input type="checkbox" [(ngModel)]="isPrivateChannel" />
              <span class="label-text">Private Channel</span>
            </label>
          </div>

          @if (isPrivateChannel) {
            <div class="members-select-area">
              <small class="label-sm">Select Members</small>
              <div class="members-scroller">
                @for (u of masterUsers; track u._id) {
                  <label class="member-row">
                    <input type="checkbox" [checked]="selectedMembers.has(u._id)" (change)="toggleMemberSelection(u._id)" />
                    <span class="name">{{ u.name }}</span>
                  </label>
                }
                @if (masterUsers.length === 0) {
                  <div class="text-muted">No other users found</div>
                }
              </div>
            </div>
          }
        </div>

        <div class="modal-footer">
          <button class="btn-ghost" (click)="closeCreateModal()">Cancel</button>
          <button class="btn-primary" (click)="submitCreateChannel()" [disabled]="!newChannelName.trim()">Create Channel</button>
        </div>
      </div>
    </div>
  }

</div> -->
